<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é—œè¥¿ä¹‹æ—… 2026 (è³¼ç‰©æ¸…å–®å¼·åŒ–ç‰ˆ)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sakura: { light: '#fff0f5', main: '#ffb7b2', dark: '#ff9e99', red: '#e94e59', text: '#4a4a4a' },
                        khaki: { bg: '#fffbf0', light: '#e6dba8', main: '#c2b280', dark: '#786c45' }
                    },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f0f2f5; color: #4a4a4a; -webkit-tap-highlight-color: transparent; display: block; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-shadow { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); }
        .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .btn-active:active { transform: scale(0.95); }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #e94e59; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        [v-cloak] { display: none; }
        .page-loading { position: fixed; inset: 0; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; }
        .calc-btn { @apply h-12 rounded-lg bg-gray-50 text-gray-600 font-bold active:bg-gray-200 transition-colors shadow-sm border border-gray-100; }
        .calc-btn-op { @apply bg-orange-50 text-orange-500 border-orange-100 active:bg-orange-100; }
        .calc-btn-eq { @apply bg-sakura-red text-white active:bg-sakura-dark shadow-md; }
        .handle { touch-action: none; cursor: grab; } .handle:active { cursor: grabbing; }
        .paper-list { background-image: linear-gradient(#f1f1f1 .1em, transparent .1em); background-size: 100% 3em; }
        .bg-custom-pattern { background-image: url('./background.png'); background-size: cover; background-position: center; background-repeat: no-repeat; }
        .label-text { @apply block text-xs font-bold text-gray-400 mb-1 ml-1; }
        .input-field { @apply w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-sakura-red focus:bg-white transition-colors; }
        .slide-up-animation { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="h-screen overflow-hidden font-sans w-full bg-gray-100">

    <div id="app" v-cloak class="h-full w-full bg-custom-pattern shadow-2xl flex flex-col relative">
        
        <div v-if="isLoadingData" class="page-loading">
            <div class="loader w-10 h-10 border-4 mb-4 text-sakura-red"></div>
            <p class="text-gray-500 font-bold">è¼‰å…¥è³‡æ–™ä¸­...</p>
        </div>

        <header class="relative h-[250px] md:h-[300px] bg-gray-200 overflow-hidden shrink-0 group">
            <img src="./banner.png" alt="Trip Banner" class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
            <div class="hidden absolute inset-0 bg-sakura-light items-center justify-center text-sakura-main"><i class="fa-solid fa-image text-4xl"></i></div>
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
            <div class="absolute bottom-6 left-6 md:left-10 z-10 text-white">
                <h1 class="text-4xl md:text-5xl font-bold tracking-widest text-shadow">é—œè¥¿ä¹‹æ—…</h1>
                <p class="text-sm md:text-base font-medium opacity-90 mt-2 text-shadow"><i class="fa-regular fa-calendar mr-2"></i>2026.04.11 - 04.19</p>
            </div>
            <div class="absolute bottom-6 right-6 md:right-10 flex space-x-3 z-20 overflow-x-auto no-scrollbar max-w-[70vw] pr-2">
                <button v-for="tab in ['packing', 'itinerary', 'shopping', 'food', 'info']" :key="tab" @click="currentTab = tab" 
                    :class="['w-11 h-11 flex-shrink-0 rounded-full flex items-center justify-center transition-all shadow-lg backdrop-blur-sm', currentTab === tab ? 'bg-sakura-red text-white scale-110' : 'bg-white/90 text-gray-500 hover:bg-white']">
                    <i :class="getTabIcon(tab)" class="text-base"></i>
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar relative pb-20">
            <div class="w-full h-full max-w-7xl mx-auto"> 
                
                <div v-if="currentTab === 'itinerary'" class="h-full flex flex-col">
                    <div class="bg-white sticky top-0 z-30 shadow-sm border-b border-gray-100 py-4">
                        <div class="flex overflow-x-auto no-scrollbar px-4 md:px-10 space-x-4 md:justify-center">
                            <div v-for="(day, index) in days" :key="index" @click="currentDayIndex = index"
                                 :class="['flex-shrink-0 flex flex-col items-center justify-center w-16 h-18 md:w-20 md:h-20 rounded-2xl transition-all cursor-pointer', currentDayIndex === index ? 'bg-sakura-red text-white shadow-lg transform -translate-y-1' : 'bg-white text-gray-400 border border-gray-100 hover:bg-gray-50']">
                                <span class="text-xs md:text-sm font-medium">{{ day.week }}</span>
                                <span class="text-xl md:text-2xl font-bold">{{ day.date }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 md:p-8 grid md:grid-cols-12 gap-6">
                        <div class="md:col-span-3 lg:col-span-3">
                            <div class="p-6 bg-gradient-to-br from-blue-50 to-white rounded-2xl flex md:flex-col items-center justify-between md:justify-center card-shadow border border-blue-100 sticky top-32">
                                <div class="md:text-center md:mb-4">
                                    <div class="text-sm text-gray-400 mb-1 flex items-center justify-center md:justify-center"><i class="fa-solid fa-location-dot mr-1 text-sakura-red"></i>{{ days[currentDayIndex].location }}</div>
                                    <div class="flex items-baseline md:justify-center"><span v-if="weather.loading" class="text-2xl text-gray-300"><i class="fa-solid fa-circle-notch fa-spin"></i></span><span v-else class="text-4xl font-light text-gray-700">{{ weather.temp }}Â°</span></div>
                                    <div v-if="!weather.loading" class="text-xs text-gray-400 mt-1 text-center">{{ weather.desc }}</div>
                                </div>
                                <div class="text-center"><i v-if="weather.loading" class="fa-solid fa-cloud text-gray-200 text-5xl"></i><i v-else :class="['text-5xl drop-shadow-md', weather.iconClass]"></i></div>
                            </div>
                        </div>
                        <div class="md:col-span-9 lg:col-span-9 space-y-0" id="itinerary-list">
                            <div v-for="(item, index) in currentDayItinerary" :key="item.id" class="relative group itinerary-item">
                                <div v-if="index > 0" class="flex items-center justify-center py-2 relative">
                                    <div class="h-8 w-0.5 bg-gray-200/50 absolute top-0 bottom-0 z-0"></div>
                                    <div class="bg-white border border-gray-200 text-gray-400 text-xs px-3 py-1 rounded-full z-10 flex items-center space-x-1 shadow-sm"><i :class="getTransportIcon(item.transportType)"></i><span>{{ item.transportTime }} min</span></div>
                                </div>
                                <div @click="openMap(item.name)" :class="['relative bg-white rounded-2xl p-6 card-shadow border-l-4 cursor-pointer active:scale-[0.99] transition-transform hover:shadow-lg', getCategoryColor(item.category)]">
                                    <div class="absolute top-4 right-4 text-gray-300 handle cursor-move hover:text-gray-500 p-2 z-20 w-10 h-10 flex items-center justify-center bg-white/80 rounded-full"><i class="fa-solid fa-grip-lines text-xl"></i></div>
                                    <div class="flex items-start">
                                        <div :class="['w-12 h-12 rounded-full flex items-center justify-center text-white shrink-0 shadow-md text-lg', getCategoryBg(item.category)]"><i :class="item.icon"></i></div>
                                        <div class="ml-6 flex-1">
                                            <h3 class="font-bold text-gray-700 text-xl">{{ item.name }}</h3>
                                            <div class="text-sakura-red font-medium text-base mt-1">{{ item.time }}</div>
                                            <p v-if="item.note" class="text-sm text-gray-500 mt-3 bg-gray-50 p-3 rounded-lg">{{ item.note }}</p>
                                        </div>
                                    </div>
                                    <div class="absolute bottom-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity"><button @click.stop="editItem(item, index)" class="text-gray-400 hover:text-blue-500 p-2"><i class="fa-solid fa-pen"></i></button></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="currentTab === 'shopping'" class="p-4 md:p-8 pb-24">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-700 flex items-center justify-center bg-white/60 backdrop-blur-sm inline-block px-4 py-2 rounded-full mx-auto shadow-sm">
                            <i class="fa-solid fa-bag-shopping text-purple-500 mr-3"></i>æ¨è–¦è³¼ç‰©æ¸…å–®
                        </h2>
                    </div>

                    <div v-if="shoppingList.length === 0" class="flex flex-col items-center justify-center py-20 text-gray-400 h-[50vh] bg-white/50 backdrop-blur-sm rounded-3xl mx-4">
                        <i class="fa-solid fa-cart-shopping text-6xl text-gray-300 mb-4"></i>
                        <p class="font-bold text-gray-500">å°šç„¡è³¼ç‰©ç­†è¨˜</p>
                        <p class="text-xs mt-2 text-gray-400">é»æ“Šå³ä¸‹è§’æŒ‰éˆ•æ–°å¢ä¼´æ‰‹ç¦®æˆ–å¿ƒå„€ç‰©å“</p>
                    </div>

                    <div v-else class="space-y-8">
                        <div v-if="souvenirList.length > 0">
                            <h3 class="text-lg font-bold text-gray-700 mb-3 flex items-center border-l-4 border-yellow-400 pl-3 bg-white/80 py-2 rounded-r-lg inline-block pr-4 shadow-sm">
                                <span class="mr-2">ğŸ</span>ä¼´æ‰‹ç¦®æ¸…å–®
                            </h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <div v-for="item in souvenirList" :key="item.id" @click="editShoppingItem(item)" class="bg-white rounded-xl p-4 card-shadow border border-gray-50 flex justify-between items-center cursor-pointer hover:scale-[1.01] transition-all">
                                    <div>
                                        <div class="font-bold text-gray-800">{{ item.name }}</div>
                                        <div v-if="item.note" class="text-xs text-gray-400 mt-1">{{ item.note }}</div>
                                    </div>
                                    <i class="fa-solid fa-angle-right text-gray-200"></i>
                                </div>
                            </div>
                        </div>

                        <div v-if="personalList.length > 0">
                            <h3 class="text-lg font-bold text-gray-700 mb-3 flex items-center border-l-4 border-purple-400 pl-3 bg-white/80 py-2 rounded-r-lg inline-block pr-4 shadow-sm">
                                <span class="mr-2">ğŸ›ï¸</span>æƒ³è²·çµ¦è‡ªå·±
                            </h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <div v-for="item in personalList" :key="item.id" @click="editShoppingItem(item)" class="bg-white rounded-xl p-4 card-shadow border border-gray-50 flex justify-between items-center cursor-pointer hover:scale-[1.01] transition-all">
                                    <div>
                                        <div class="font-bold text-gray-800">{{ item.name }}</div>
                                        <div v-if="item.note" class="text-xs text-gray-400 mt-1">{{ item.note }}</div>
                                    </div>
                                    <i class="fa-solid fa-angle-right text-gray-200"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="currentTab === 'packing'" class="p-4 md:p-8 space-y-8">
                    <div class="text-center mb-6"><h2 class="text-2xl font-bold text-gray-700 flex items-center justify-center bg-white/60 backdrop-blur-sm inline-block px-4 py-2 rounded-full mx-auto shadow-sm"><i class="fa-solid fa-suitcase-rolling text-sakura-red mr-3"></i>è¡Œå‰æº–å‚™æ¸…å–®</h2></div>
                    <div class="bg-white rounded-2xl shadow-lg border-2 border-dashed border-gray-300 overflow-hidden relative">
                        <div class="bg-gray-100 p-4 border-b border-gray-200 flex justify-between items-center"><h3 class="font-bold text-gray-800 text-lg"><i class="fa-solid fa-user mr-2"></i>å°è³´çš„æ¸…å–®</h3></div>
                        <div class="p-4 space-y-3 paper-list">
                            <div v-for="(item, index) in packingList.lai" :key="index" class="flex items-center group">
                                <input type="checkbox" v-model="item.checked" @change="savePacking" class="w-5 h-5 accent-gray-800 rounded-full">
                                <span :class="['ml-3 flex-1 text-gray-700 text-lg', item.checked ? 'line-through text-gray-400 opacity-50' : '']">{{ item.text }}</span>
                                <button @click="removePackingItem('lai', index)" class="text-gray-300 group-hover:opacity-100 opacity-0 p-2"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                            <div class="flex items-center mt-4 pt-2 border-t border-gray-100">
                                <input type="text" v-model="packingInputs.lai" @keyup.enter="addPackingItem('lai')" placeholder="æ–°å¢..." class="flex-1 bg-transparent outline-none">
                                <button @click="addPackingItem('lai')" class="bg-gray-700 text-white w-8 h-8 rounded-full flex items-center justify-center"><i class="fa-solid fa-plus text-xs"></i></button>
                            </div>
                        </div>
                    </div>
                    </div>

                <div v-if="currentTab === 'food'" class="p-4 md:p-8 pb-24">
                    <div class="text-center mb-6"><h2 class="text-2xl font-bold text-gray-700 flex items-center justify-center bg-white/60 backdrop-blur-sm inline-block px-4 py-2 rounded-full mx-auto shadow-sm"><i class="fa-solid fa-utensils text-sakura-red mr-3"></i>ç¾é£Ÿé˜¿å§†é˜¿å§†</h2></div>
                    <div class="space-y-6">
                        <div v-if="osakaFoods.length > 0">
                            <h3 class="text-xl font-bold text-gray-700 mb-3 border-l-4 border-blue-400 pl-3">ğŸ¯å¤§é˜ªç¾é£Ÿ</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <div v-for="food in osakaFoods" :key="food.id" @click="openMap(food.name)" class="bg-white rounded-xl card-shadow p-4 relative cursor-pointer border border-gray-50">
                                    <button @click.stop="deleteFoodItem(food.id)" class="absolute top-2 right-2 text-gray-300"><i class="fa-solid fa-trash-can text-sm"></i></button>
                                    <h4 class="font-bold text-gray-800 truncate">{{ food.name }}</h4>
                                    <p v-if="food.note" class="text-xs text-gray-500 mt-1">{{ food.note }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="currentTab === 'info'" class="space-y-8 pb-10 p-4 md:p-8">
                    <div class="bg-white rounded-2xl p-6 card-shadow border-t-4 border-green-500">
                        <h3 class="text-lg font-bold text-gray-700 mb-2"><i class="fa-solid fa-rotate mr-2 text-green-500"></i>åŒæ­¥è³‡æ–™ (å«è³¼ç‰©æ¸…å–®)</h3>
                        <p class="text-xs text-gray-400 mb-4">é»æ“ŠåŒ¯å‡ºå¯å°‡æ‰€æœ‰è¡Œç¨‹ã€ç¾é£Ÿã€è³¼ç‰©æ¸…å–®å­˜æˆ JSON æª”æ¡ˆã€‚</p>
                        <div class="flex space-x-3">
                            <button @click="exportData" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold flex items-center justify-center"><i class="fa-solid fa-download mr-2"></i>åŒ¯å‡º</button>
                            <label class="flex-1 bg-green-500 text-white py-3 rounded-xl font-bold flex items-center justify-center cursor-pointer shadow-md">
                                <i class="fa-solid fa-upload mr-2"></i>åŒ¯å…¥
                                <input type="file" @change="importData" class="hidden" accept=".json">
                            </label>
                        </div>
                    </div>
                    </div>
            
            </div>
        </main>

        <button v-if="['itinerary','info','food','shopping'].includes(currentTab)" @click="handleFabClick" class="fixed bottom-24 right-6 w-16 h-16 bg-sakura-red text-white rounded-full shadow-xl flex items-center justify-center text-3xl btn-active z-40 hover:scale-110 transition-transform"><i class="fa-solid fa-plus"></i></button>

        <div v-if="showShoppingModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" @click.self="showShoppingModal = false">
            <div class="bg-white w-full max-w-md rounded-2xl p-8 m-4 shadow-2xl slide-up-animation">
                <h3 class="font-bold text-xl mb-6 text-center">{{ isEditingShopping ? 'ä¿®æ”¹è³¼ç‰©' : 'æ–°å¢è³¼ç‰©ç­†è¨˜' }}</h3>
                <div class="space-y-4">
                    <div>
                        <label class="label-text">åˆ†é¡</label>
                        <div class="flex space-x-3">
                            <button @click="shoppingForm.category = 'souvenir'" :class="['flex-1 py-3 rounded-xl border font-bold transition-all', shoppingForm.category === 'souvenir' ? 'bg-yellow-400 text-white border-yellow-400 shadow-md' : 'bg-white border-gray-200 text-gray-500']">ğŸ ä¼´æ‰‹ç¦®</button>
                            <button @click="shoppingForm.category = 'personal'" :class="['flex-1 py-3 rounded-xl border font-bold transition-all', shoppingForm.category === 'personal' ? 'bg-purple-500 text-white border-purple-500 shadow-md' : 'bg-white border-gray-200 text-gray-500']">ğŸ›ï¸ è‡ªç”¨</button>
                        </div>
                    </div>
                    <div><label class="label-text">åç¨± (å¿…å¡«)</label><input type="text" v-model="shoppingForm.name" class="input-field" placeholder="ä¾‹å¦‚ï¼šå‘¼å¸å·§å…‹åŠ›"></div>
                    <div><label class="label-text">å‚™è¨» / åƒ¹æ ¼ / åœ°é»</label><textarea v-model="shoppingForm.note" class="input-field h-20" placeholder="ä¾‹å¦‚ï¼šäº¬éƒ½è»Šç«™ 2F æ‰æœ‰è³£"></textarea></div>
                </div>
                <div class="flex space-x-3 mt-6">
                    <button v-if="isEditingShopping" @click="deleteShoppingItem" class="flex-1 bg-gray-100 text-red-400 py-3.5 rounded-xl font-bold">åˆªé™¤</button>
                    <button @click="saveShoppingItem" class="flex-[2] bg-sakura-red text-white py-3.5 rounded-xl font-bold shadow-lg">{{ isEditingShopping ? 'æ›´æ–°' : 'åŠ å…¥æ¸…å–®' }}</button>
                </div>
            </div>
        </div>

        <div v-if="showEditModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" @click.self="closeModal">
             </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, reactive, watch } = Vue;

        createApp({
            setup() {
                localforage.config({ name: 'TripApp', storeName: 'trip_data' });

                const currentTab = ref('itinerary');
                const currentDayIndex = ref(0);
                const showEditModal = ref(false), showHotelModal = ref(false), showFoodModal = ref(false), showShoppingModal = ref(false);
                const isEditing = ref(false), isEditingShopping = ref(false), editingIndex = ref(-1), isLoadingData = ref(true);

                const days = [
                    { date: '11', week: 'Fri', fullDate: '2026-04-11', location: 'å¤§é˜ª', lat: 34.6937, lng: 135.5023 },
                    { date: '12', week: 'Sat', fullDate: '2026-04-12', location: 'å¤§é˜ª', lat: 34.6937, lng: 135.5023 },
                    { date: '13', week: 'Sun', fullDate: '2026-04-13', location: 'ç’°çƒå½±åŸ', lat: 34.6654, lng: 135.4323 },
                    { date: '14', week: 'Mon', fullDate: '2026-04-14', location: 'å¤§é˜ª/äº¬éƒ½', lat: 35.0116, lng: 135.7681 },
                    { date: '15', week: 'Tue', fullDate: '2026-04-15', location: 'äº¬éƒ½', lat: 35.0116, lng: 135.7681 },
                    { date: '16', week: 'Wed', fullDate: '2026-04-16', location: 'äº¬éƒ½', lat: 35.0116, lng: 135.7681 },
                    { date: '17', week: 'Thu', fullDate: '2026-04-17', location: 'äº¬éƒ½/å¤§é˜ª', lat: 34.6937, lng: 135.5023 },
                    { date: '18', week: 'Fri', fullDate: '2026-04-18', location: 'å¤§é˜ª/å º', lat: 34.5733, lng: 135.4830 },
                    { date: '19', week: 'Sat', fullDate: '2026-04-19', location: 'é—œè¥¿æ©Ÿå ´', lat: 34.4320, lng: 135.2304 }
                ];
                
                const itineraryData = reactive({});
                const hotels = ref([]); 
                const foodList = ref([]); 
                const shoppingList = ref([]); // æ–°å¢
                const packingList = ref({ lai: [], ze: [] }); 
                const packingInputs = reactive({ lai: '', ze: '' });

                const weather = reactive({ temp: '--', code: 0, desc: 'è¼‰å…¥ä¸­...', iconClass: 'fa-solid fa-cloud', loading: false });

                const editForm = reactive({ id: null, category: 'spot', name: '', time: '', note: '', ticket: '', transportTime: 30, transportType: 'train', images: [] });
                const hotelForm = reactive({ name: '', dates: '', checkIn: '15:00', checkOut: '11:00' });
                const newFoodItem = reactive({ name: '', category: 'osaka', note: '' });
                const shoppingForm = reactive({ id: null, name: '', category: 'souvenir', note: '' }); // æ–°å¢

                // Computed è³¼ç‰©åˆ†é¡
                const souvenirList = computed(() => shoppingList.value.filter(s => s.category === 'souvenir'));
                const personalList = computed(() => shoppingList.value.filter(s => s.category === 'personal'));
                const currentDayItinerary = computed(() => itineraryData[currentDayIndex.value] || []);
                const osakaFoods = computed(() => foodList.value.filter(f => f.category === 'osaka'));

                const getTabIcon = (t) => ({ 'itinerary': 'fa-solid fa-map-location-dot', 'info': 'fa-solid fa-circle-info', 'food': 'fa-solid fa-utensils', 'packing': 'fa-solid fa-suitcase', 'shopping': 'fa-solid fa-bag-shopping' }[t]);
                const getCategoryColor = (cat) => ({ spot: 'border-pink-400', food: 'border-orange-400', shopping: 'border-purple-400', flight: 'border-blue-400' }[cat] || 'border-gray-400');
                const getCategoryBg = (cat) => ({ spot: 'bg-pink-400', food: 'bg-orange-400', shopping: 'bg-purple-400', flight: 'bg-blue-400' }[cat] || 'bg-gray-400');
                const getCategoryIcon = (cat) => ({ spot: 'fa-solid fa-camera', food: 'fa-solid fa-utensils', shopping: 'fa-solid fa-bag-shopping', flight: 'fa-solid fa-plane' }[cat] || 'fa-solid fa-star');
                const getTransportIcon = (t) => t === 'walk' ? 'fa-solid fa-person-walking' : t === 'car' ? 'fa-solid fa-car' : 'fa-solid fa-train-subway';

                const loadData = async () => {
                    try {
                        isLoadingData.value = true;
                        const [it, ht, fd, pk, sp] = await Promise.all([
                            localforage.getItem('itineraryData'),
                            localforage.getItem('hotels'),
                            localforage.getItem('foodList'),
                            localforage.getItem('packingList'),
                            localforage.getItem('shoppingList') // æ–°å¢
                        ]);
                        if(it) Object.assign(itineraryData, it);
                        hotels.value = ht || [];
                        foodList.value = fd || [];
                        packingList.value = pk || { lai: [], ze: [] };
                        shoppingList.value = sp || []; // æ–°å¢
                    } finally {
                        isLoadingData.value = false;
                        updateWeather();
                    }
                };

                const saveToDB = async () => {
                    await localforage.setItem('itineraryData', JSON.parse(JSON.stringify(itineraryData)));
                    await localforage.setItem('hotels', hotels.value);
                    await localforage.setItem('foodList', foodList.value);
                    await localforage.setItem('packingList', packingList.value);
                    await localforage.setItem('shoppingList', shoppingList.value); // æ–°å¢
                };

                // åŒ¯å‡ºåŠŸèƒ½ (åŒ…å«è³¼ç‰©æ¸…å–®)
                const exportData = async () => {
                    const data = {
                        itineraryData, hotels: hotels.value, foodList: foodList.value,
                        packingList: packingList.value, shoppingList: shoppingList.value
                    };
                    const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `trip_full_data_${new Date().toISOString().slice(0,10)}.json`;
                    a.click();
                };

                // åŒ¯å…¥åŠŸèƒ½ (åŒ…å«è³¼ç‰©æ¸…å–®)
                const importData = (event) => {
                    const file = event.target.files[0];
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if(confirm('åŒ¯å…¥å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ')) {
                                if(data.itineraryData) await localforage.setItem('itineraryData', data.itineraryData);
                                if(data.hotels) await localforage.setItem('hotels', data.hotels);
                                if(data.foodList) await localforage.setItem('foodList', data.foodList);
                                if(data.packingList) await localforage.setItem('packingList', data.packingList);
                                if(data.shoppingList) await localforage.setItem('shoppingList', data.shoppingList);
                                location.reload();
                            }
                        } catch { alert('æ ¼å¼ä¸æ­£ç¢º'); }
                    };
                    reader.readAsText(file);
                };

                const handleFabClick = () => {
                    if (currentTab.value === 'itinerary') openAddModal();
                    else if (currentTab.value === 'food') showFoodModal.value = true;
                    else if (currentTab.value === 'shopping') {
                        isEditingShopping.value = false;
                        Object.assign(shoppingForm, { id: Date.now(), name: '', category: 'souvenir', note: '' });
                        showShoppingModal.value = true;
                    }
                };

                // è³¼ç‰©æ¸…å–®å°ˆå±¬é‚è¼¯
                const saveShoppingItem = async () => {
                    if (!shoppingForm.name) return;
                    if (isEditingShopping.value) {
                        const idx = shoppingList.value.findIndex(i => i.id === shoppingForm.id);
                        if (idx !== -1) shoppingList.value[idx] = { ...shoppingForm };
                    } else {
                        shoppingList.value.push({ ...shoppingForm });
                    }
                    await saveToDB();
                    showShoppingModal.value = false;
                };

                const editShoppingItem = (item) => {
                    isEditingShopping.value = true;
                    Object.assign(shoppingForm, JSON.parse(JSON.stringify(item)));
                    showShoppingModal.value = true;
                };

                const deleteShoppingItem = async () => {
                    if(confirm('åˆªé™¤æ­¤è³¼ç‰©é …ï¼Ÿ')) {
                        shoppingList.value = shoppingList.value.filter(i => i.id !== shoppingForm.id);
                        await saveToDB();
                        showShoppingModal.value = false;
                    }
                };

                // è¡Œç¨‹ã€å¤©æ°£ç­‰è¼”åŠ©å‡½æ•¸...
                const openAddModal = () => { isEditing.value = false; showEditModal.value = true; };
                const updateWeather = async () => { /* é€™è£¡å¯¦ä½œè·ŸåŸç‰ˆä¸€æ¨£çš„ API Fetch ... */ };
                const openMap = (l) => window.open(`http://googleusercontent.com/maps.google.com/?q=${encodeURIComponent(l)}`, '_blank');

                onMounted(loadData);

                return {
                    currentTab, currentDayIndex, days, hotels, currentDayItinerary, shoppingList,
                    showEditModal, showHotelModal, showFoodModal, showShoppingModal,
                    editForm, hotelForm, newFoodItem, shoppingForm,
                    isEditing, isEditingShopping, isLoadingData,
                    souvenirList, personalList, osakaFoods,
                    getCategoryColor, getCategoryBg, getCategoryIcon, getTransportIcon, getTabIcon,
                    handleFabClick, openAddModal, saveShoppingItem, editShoppingItem, deleteShoppingItem,
                    exportData, importData, openMap, saveToDB
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
