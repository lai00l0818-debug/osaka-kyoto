<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é—œè¥¿ä¹‹æ—… 2026 (ç¾é£Ÿæ¸…å–®ç‰ˆ)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sakura: { light: '#fff0f5', main: '#ffb7b2', dark: '#ff9e99', red: '#e94e59', text: '#4a4a4a' }
                    },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f0f2f5; color: #4a4a4a; -webkit-tap-highlight-color: transparent; display: block; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-shadow { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); }
        .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .btn-active:active { transform: scale(0.95); }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #e94e59; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        [v-cloak] { display: none; }
        .page-loading { position: fixed; inset: 0; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; }
        
        .calc-btn { @apply h-12 rounded-lg bg-gray-50 text-gray-600 font-bold active:bg-gray-200 transition-colors shadow-sm border border-gray-100; }
        .calc-btn-op { @apply bg-orange-50 text-orange-500 border-orange-100 active:bg-orange-100; }
        .calc-btn-eq { @apply bg-sakura-red text-white active:bg-sakura-dark shadow-md; }

        .sortable-ghost { opacity: 0.4; background-color: #fff0f5; border: 2px dashed #ffb7b2; }
        .sortable-fallback { opacity: 1 !important; background-color: white; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); transform: scale(1.02); border-radius: 1rem; cursor: grabbing; }
        .handle { touch-action: none; cursor: grab; } .handle:active { cursor: grabbing; }
    </style>
</head>
<body class="h-screen overflow-hidden font-sans w-full bg-gray-100">

    <div id="app" v-cloak class="h-full w-full bg-white shadow-2xl flex flex-col relative">
        
        <div v-if="isLoadingData" class="page-loading">
            <div class="loader w-10 h-10 border-4 mb-4 text-sakura-red"></div>
            <p class="text-gray-500 font-bold">è¼‰å…¥è³‡æ–™ä¸­...</p>
        </div>

        <header class="relative h-[250px] md:h-[300px] bg-gray-200 overflow-hidden shrink-0 group">
            <img src="./banner.png" alt="Trip Banner" class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
            <div class="hidden absolute inset-0 bg-sakura-light items-center justify-center text-sakura-main"><i class="fa-solid fa-image text-4xl"></i></div>
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
            <div class="absolute bottom-6 left-6 md:left-10 z-10 text-white">
                <h1 class="text-4xl md:text-5xl font-bold tracking-widest text-shadow">é—œè¥¿ä¹‹æ—…</h1>
                <p class="text-sm md:text-base font-medium opacity-90 mt-2 text-shadow"><i class="fa-regular fa-calendar mr-2"></i>2026.04.11 - 04.19</p>
            </div>
            <div class="absolute bottom-6 right-6 md:right-10 flex space-x-3 z-20 overflow-x-auto no-scrollbar max-w-[60vw] pr-2">
                <button v-for="tab in ['itinerary', 'food', 'shopping', 'info', 'expenses']" :key="tab" @click="currentTab = tab" 
                    :class="['w-11 h-11 flex-shrink-0 rounded-full flex items-center justify-center transition-all shadow-lg backdrop-blur-sm', currentTab === tab ? 'bg-sakura-red text-white scale-110' : 'bg-white/90 text-gray-500 hover:bg-white']">
                    <i :class="getTabIcon(tab)" class="text-base"></i>
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar relative bg-gray-50 pb-20">
            <div class="w-full h-full max-w-7xl mx-auto"> 
                
                <div v-if="currentTab === 'itinerary'" class="h-full flex flex-col">
                    <div class="bg-white sticky top-0 z-30 shadow-sm border-b border-gray-100 py-4">
                        <div class="flex overflow-x-auto no-scrollbar px-4 md:px-10 space-x-4 md:justify-center">
                            <div v-for="(day, index) in days" :key="index" @click="currentDayIndex = index"
                                 :class="['flex-shrink-0 flex flex-col items-center justify-center w-16 h-18 md:w-20 md:h-20 rounded-2xl transition-all cursor-pointer', currentDayIndex === index ? 'bg-sakura-red text-white shadow-lg transform -translate-y-1' : 'bg-white text-gray-400 border border-gray-100 hover:bg-gray-50']">
                                <span class="text-xs md:text-sm font-medium">{{ day.week }}</span>
                                <span class="text-xl md:text-2xl font-bold">{{ day.date }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 md:p-8 grid md:grid-cols-12 gap-6">
                        <div class="md:col-span-3 lg:col-span-3">
                            <div class="p-6 bg-gradient-to-br from-blue-50 to-white rounded-2xl flex md:flex-col items-center justify-between md:justify-center card-shadow border border-blue-100 sticky top-32">
                                <div class="md:text-center md:mb-4">
                                    <div class="text-sm text-gray-400 mb-1 flex items-center justify-center md:justify-center"><i class="fa-solid fa-location-dot mr-1 text-sakura-red"></i>{{ days[currentDayIndex].location }}</div>
                                    <div class="flex items-baseline md:justify-center"><span v-if="weather.loading" class="text-2xl text-gray-300"><i class="fa-solid fa-circle-notch fa-spin"></i></span><span v-else class="text-4xl font-light text-gray-700">{{ weather.temp }}Â°</span><span v-if="!weather.loading" class="text-xs text-gray-400 ml-1">ç¾åœ¨</span></div>
                                    <div v-if="!weather.loading" class="text-xs text-gray-400 mt-1 md:mt-2 text-center">{{ weather.desc }}</div>
                                </div>
                                <div class="text-center"><i v-if="weather.loading" class="fa-solid fa-cloud text-gray-200 text-5xl"></i><i v-else :class="['text-5xl drop-shadow-md transition-all duration-500', weather.iconClass]"></i></div>
                            </div>
                        </div>

                        <div class="md:col-span-9 lg:col-span-9 space-y-0" id="itinerary-list">
                            <div v-for="(item, index) in currentDayItinerary" :key="item.id" class="relative group itinerary-item">
                                <div v-if="index > 0" class="flex items-center justify-center py-2 relative">
                                    <div class="h-8 w-0.5 bg-gray-200 absolute top-0 bottom-0 z-0"></div>
                                    <div class="bg-white border border-gray-200 text-gray-400 text-xs px-3 py-1 rounded-full z-10 flex items-center space-x-1 shadow-sm"><i :class="getTransportIcon(item.transportType)"></i><span>{{ item.transportTime }} min</span></div>
                                </div>
                                <div v-else-if="index === 0 && !item.isFlight" class="flex items-center justify-center py-2 pb-4"><div class="text-xs text-gray-400 bg-gray-200 px-3 py-1 rounded-full"><i class="fa-solid fa-hotel mr-1"></i> å¾é£¯åº—å‡ºç™¼ç´„ {{ item.transportTime }} min</div></div>

                                <div @click="openMap(item.name)" :class="['relative bg-white rounded-2xl p-6 card-shadow border-l-4 cursor-pointer active:scale-[0.99] transition-transform hover:shadow-lg', getCategoryColor(item.category)]">
                                    <div class="absolute top-4 right-4 text-gray-300 handle cursor-move hover:text-gray-500 p-2 z-20 w-10 h-10 flex items-center justify-center bg-white/80 rounded-full shadow-sm"><i class="fa-solid fa-grip-lines text-xl"></i></div>
                                    <div class="flex items-start">
                                        <div :class="['w-12 h-12 rounded-full flex items-center justify-center text-white shrink-0 shadow-md text-lg', getCategoryBg(item.category)]"><i :class="item.icon"></i></div>
                                        <div class="ml-6 flex-1 overflow-hidden">
                                            <div class="flex justify-between items-baseline pr-12"><h3 class="font-bold text-gray-700 text-xl">{{ item.name }}</h3></div>
                                            <div class="text-sakura-red font-medium text-base mt-1">{{ item.time }}</div>
                                            <div class="flex flex-wrap gap-2 mt-3" v-if="item.ticket || item.openTime"><span v-if="item.ticket" class="text-sm bg-yellow-50 text-yellow-600 px-2 py-1 rounded border border-yellow-100"><i class="fa-solid fa-ticket mr-1"></i>{{ item.ticket }}</span></div>
                                            <p v-if="item.note" class="text-sm text-gray-500 mt-3 bg-gray-50 p-3 rounded-lg">{{ item.note }}</p>
                                            <div v-if="item.images && item.images.length > 0" class="mt-4"><div class="flex space-x-3 overflow-x-auto no-scrollbar pb-2"><img v-for="(img, imgIdx) in item.images" :key="imgIdx" :src="img" class="h-40 w-auto rounded-xl border border-gray-100 shadow-sm cursor-pointer hover:opacity-90 transition-opacity" @click.stop="openImage(img)"></div></div>
                                            <div v-else-if="item.image" class="mt-4"><img :src="item.image" class="w-full md:w-2/3 h-48 object-cover rounded-xl border border-gray-100 shadow-sm"></div>
                                        </div>
                                    </div>
                                    <div class="absolute bottom-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity"><button @click.stop="editItem(item, index)" class="text-gray-400 hover:text-blue-500 p-2 bg-gray-50 rounded-full"><i class="fa-solid fa-pen"></i></button></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="currentTab === 'food'" class="p-4 md:p-8 pb-24">
                    <div v-if="foodList.length === 0" class="flex flex-col items-center justify-center py-20 text-gray-400 h-[50vh]">
                        <i class="fa-solid fa-utensils text-6xl text-gray-200 mb-4"></i>
                        <p>å°šç„¡ç¾é£Ÿæ¸…å–®</p>
                        <p class="text-xs mt-2 text-gray-300">é»æ“Šå³ä¸‹è§’æŒ‰éˆ•æ–°å¢</p>
                    </div>

                    <div v-else class="space-y-8">
                        <div v-if="osakaFoods.length > 0">
                            <h3 class="text-xl font-bold text-gray-700 mb-4 flex items-center border-l-4 border-blue-400 pl-3">
                                <span class="mr-2">ğŸ¯</span>å¤§é˜ªç¾é£Ÿ
                            </h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div v-for="food in osakaFoods" :key="food.id" @click="openMap(food.name)" class="bg-white rounded-xl card-shadow overflow-hidden group cursor-pointer hover:shadow-lg transition-shadow">
                                    <div class="h-40 bg-gray-100 flex items-center justify-center overflow-hidden relative">
                                        <img v-if="food.image" :src="food.image" class="w-full h-full object-cover">
                                        <div v-else class="text-gray-300 flex flex-col items-center"><i class="fa-solid fa-burger text-3xl mb-1"></i><span class="text-xs">ç„¡åœ–ç‰‡</span></div>
                                        <button @click.stop="deleteFoodItem(food.id)" class="absolute top-2 right-2 w-8 h-8 bg-black/50 text-white rounded-full flex items-center justify-center hover:bg-red-500 transition-colors"><i class="fa-solid fa-trash-can text-sm"></i></button>
                                    </div>
                                    <div class="p-4">
                                        <div class="flex justify-between items-start">
                                            <h4 class="font-bold text-gray-800 text-lg truncate flex-1">{{ food.name }}</h4>
                                            <i class="fa-solid fa-location-arrow text-gray-300 text-sm ml-2"></i>
                                        </div>
                                        <p v-if="food.note" class="text-sm text-gray-500 mt-2 bg-gray-50 p-2 rounded">{{ food.note }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div v-if="kyotoFoods.length > 0">
                            <h3 class="text-xl font-bold text-gray-700 mb-4 flex items-center border-l-4 border-red-400 pl-3">
                                <span class="mr-2">â›©ï¸</span>äº¬éƒ½ç¾é£Ÿ
                            </h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div v-for="food in kyotoFoods" :key="food.id" @click="openMap(food.name)" class="bg-white rounded-xl card-shadow overflow-hidden group cursor-pointer hover:shadow-lg transition-shadow">
                                    <div class="h-40 bg-gray-100 flex items-center justify-center overflow-hidden relative">
                                        <img v-if="food.image" :src="food.image" class="w-full h-full object-cover">
                                        <div v-else class="text-gray-300 flex flex-col items-center"><i class="fa-solid fa-bowl-food text-3xl mb-1"></i><span class="text-xs">ç„¡åœ–ç‰‡</span></div>
                                        <button @click.stop="deleteFoodItem(food.id)" class="absolute top-2 right-2 w-8 h-8 bg-black/50 text-white rounded-full flex items-center justify-center hover:bg-red-500 transition-colors"><i class="fa-solid fa-trash-can text-sm"></i></button>
                                    </div>
                                    <div class="p-4">
                                        <div class="flex justify-between items-start">
                                            <h4 class="font-bold text-gray-800 text-lg truncate flex-1">{{ food.name }}</h4>
                                            <i class="fa-solid fa-location-arrow text-gray-300 text-sm ml-2"></i>
                                        </div>
                                        <p v-if="food.note" class="text-sm text-gray-500 mt-2 bg-gray-50 p-2 rounded">{{ food.note }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="currentTab === 'info'" class="space-y-8 pb-10 p-4 md:p-8">
                    <div class="bg-white rounded-2xl p-6 card-shadow border-t-4 border-sakura-red">
                        <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-gray-700"><i class="fa-solid fa-calculator mr-2 text-gray-400"></i>åŒ¯ç‡è¨ˆç®—æ©Ÿ</h3><div class="text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded">åŒ¯ç‡: 0.22</div></div>
                        <div class="bg-gray-100 rounded-xl p-4 mb-4 text-right">
                            <div class="text-gray-500 text-sm h-5 overflow-hidden">{{ calcFormula || ' ' }}</div>
                            <div class="text-3xl font-bold text-gray-800 break-all">{{ calcInput || '0' }} <span class="text-sm font-normal text-gray-400">JPY</span></div>
                            <div class="text-sakura-red font-bold text-xl mt-1 border-t border-gray-200 pt-1">{{ calcResultTwd }} <span class="text-xs font-normal">TWD</span></div>
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            <button @click="appendCalc('7')" class="calc-btn">7</button><button @click="appendCalc('8')" class="calc-btn">8</button><button @click="appendCalc('9')" class="calc-btn">9</button><button @click="appendCalc('/')" class="calc-btn calc-btn-op"><i class="fa-solid fa-divide"></i></button>
                            <button @click="appendCalc('4')" class="calc-btn">4</button><button @click="appendCalc('5')" class="calc-btn">5</button><button @click="appendCalc('6')" class="calc-btn">6</button><button @click="appendCalc('*')" class="calc-btn calc-btn-op"><i class="fa-solid fa-xmark"></i></button>
                            <button @click="appendCalc('1')" class="calc-btn">1</button><button @click="appendCalc('2')" class="calc-btn">2</button><button @click="appendCalc('3')" class="calc-btn">3</button><button @click="appendCalc('-')" class="calc-btn calc-btn-op"><i class="fa-solid fa-minus"></i></button>
                            <button @click="appendCalc('0')" class="calc-btn">0</button><button @click="appendCalc('.')" class="calc-btn">.</button><button @click="clearCalc()" class="calc-btn text-red-400">C</button><button @click="appendCalc('+')" class="calc-btn calc-btn-op"><i class="fa-solid fa-plus"></i></button>
                        </div>
                        <button @click="calculateFinal()" class="w-full mt-2 h-12 rounded-lg bg-sakura-red text-white font-bold shadow-md active:bg-sakura-dark transition-colors text-lg">=</button>
                    </div>

                    <div class="bg-white rounded-2xl p-6 card-shadow">
                        <h3 class="text-lg font-bold text-gray-700 mb-4 flex justify-between items-center"><span><i class="fa-solid fa-bed mr-2 text-purple-400"></i>ä½å®¿è³‡è¨Š</span></h3>
                        <div v-if="hotels.length === 0" class="text-center py-8 text-gray-400 text-sm">å°šç„¡ä½å®¿è³‡æ–™ï¼Œè«‹é»æ“Š + æ–°å¢</div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div v-for="(hotel, index) in hotels" :key="hotel.id || index" class="p-4 border border-gray-100 rounded-xl hover:bg-gray-50 transition-colors relative group">
                                <button @click="deleteHotel(index)" class="absolute top-2 right-2 text-gray-200 hover:text-red-400 p-1"><i class="fa-solid fa-trash-can"></i></button>
                                <div class="text-xs text-sakura-red mb-1 font-bold">{{ hotel.dates }}</div><div class="font-bold text-gray-800 text-lg mb-2">{{ hotel.name }}</div>
                                <div class="flex items-center text-xs text-gray-500 mb-3 space-x-3 bg-gray-50 p-2 rounded-lg"><span v-if="hotel.checkIn"><i class="fa-solid fa-clock mr-1 text-green-400"></i>å…¥ä½ {{ hotel.checkIn }}</span><span class="text-gray-300">|</span><span v-if="hotel.checkOut"><i class="fa-solid fa-person-walking-luggage mr-1 text-orange-400"></i>é€€æˆ¿ {{ hotel.checkOut }}</span></div>
                                <div class="flex space-x-3"><a :href="'https://www.google.com/maps/search/?api=1&query=' + hotel.name" target="_blank" class="flex-1 bg-white border border-gray-200 text-center py-2 rounded-lg text-sm text-gray-600 hover:bg-gray-100 transition-colors"><i class="fa-solid fa-location-arrow mr-1"></i>å°èˆª</a></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="currentTab === 'shopping'" class="p-4 md:p-8">
                     <div v-if="!shoppingList || shoppingList.length === 0" class="flex flex-col items-center justify-center py-20 text-gray-400 h-[60vh]"><i class="fa-solid fa-basket-shopping text-6xl text-gray-200 mb-4"></i><p>å°šç„¡è³¼ç‰©æ¸…å–®</p><p class="text-xs mt-2 text-gray-300">é»æ“Šå³ä¸‹è§’æŒ‰éˆ•æ–°å¢</p></div>
                     <div v-else class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        <div v-for="(item, index) in shoppingList" :key="index" class="bg-white rounded-xl card-shadow overflow-hidden group">
                            <div class="h-40 bg-gray-100 flex items-center justify-center overflow-hidden"><img v-if="item.image" :src="item.image" class="w-full h-full object-cover"><i v-else class="fa-solid fa-camera text-gray-300 text-3xl"></i></div>
                            <div class="p-4"><h4 class="font-bold text-gray-700 truncate">{{ item.name }}</h4><div class="flex justify-between mt-2"><label class="flex items-center cursor-pointer"><input type="checkbox" v-model="item.checked" class="w-5 h-5 accent-sakura-red"><span class="text-xs ml-2 text-gray-400" v-if="item.checked">å·²è³¼è²·</span></label><button @click="deleteShoppingItem(index)"><i class="fa-solid fa-trash-can text-gray-300 hover:text-red-400"></i></button></div></div>
                        </div>
                     </div>
                </div>

                <div v-if="currentTab === 'expenses'" class="flex flex-col h-full p-4 md:p-8">
                    <div class="bg-white p-6 rounded-2xl card-shadow text-center mb-6 max-w-2xl mx-auto w-full"><p class="text-sm text-gray-400">ç¸½æ”¯å‡º (JPY)</p><div class="text-5xl font-bold text-sakura-red mt-3">Â¥ {{ totalExpenses.toLocaleString() }}</div><div class="mt-4 flex justify-center space-x-4 text-xs text-gray-500"><span>ç¾é‡‘: {{ cashExpenses.toLocaleString() }}</span><span>ä¿¡ç”¨å¡: {{ cardExpenses.toLocaleString() }}</span></div></div>
                    <div v-if="!expenses || expenses.length === 0" class="flex flex-col items-center justify-center py-10 text-gray-400"><i class="fa-solid fa-receipt text-6xl text-gray-200 mb-4"></i><p>å°šç„¡è¨˜å¸³ç´€éŒ„</p></div>
                    <div class="space-y-3 pb-20 max-w-4xl mx-auto w-full">
                        <div v-for="(exp, index) in expenses" :key="index" class="bg-white p-4 rounded-xl flex justify-between items-center card-shadow">
                            <div class="flex items-center"><div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-500 mr-3"><i :class="getExpenseIcon(exp.category)"></i></div><div><div class="font-bold text-gray-700">{{ exp.name }}</div><div class="text-xs text-gray-400">{{ exp.date }} Â· {{ exp.category }}</div></div></div>
                            <div class="flex items-center"><div class="font-bold text-lg mr-4">Â¥ {{ exp.amount }}</div><button @click="deleteExpense(index)" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash"></i></button></div>
                        </div>
                    </div>
                </div>
            
            </div> </main>

        <button v-if="['itinerary','shopping','expenses','info','food'].includes(currentTab)" @click="handleFabClick" class="fixed bottom-24 right-6 w-16 h-16 bg-sakura-red text-white rounded-full shadow-xl flex items-center justify-center text-3xl btn-active z-40 hover:scale-110 transition-transform"><i class="fa-solid fa-plus"></i></button>

        <div v-if="showEditModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="closeModal">
            <div class="bg-white w-full max-w-lg rounded-t-2xl sm:rounded-2xl p-6 h-[90vh] sm:h-auto flex flex-col shadow-2xl slide-up-animation">
                <h3 class="text-xl font-bold mb-6 text-center shrink-0">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
                <div class="space-y-5 flex-1 overflow-y-auto pr-2">
                    <div><label class="label-text">åˆ†é¡</label><select v-model="editForm.category" class="input-field"><option value="spot">æ™¯é»</option><option value="food">ç¾é£Ÿ</option><option value="shopping">è³¼ç‰©</option><option value="hotel">ä½å®¿</option><option value="flight">èˆªç­</option><option value="other">å…¶ä»–</option></select></div>
                    <div><label class="label-text">åç¨±</label><input type="text" v-model="editForm.name" class="input-field" placeholder="è¡Œç¨‹åç¨±"></div>
                    <div class="grid grid-cols-2 gap-4"><div><label class="label-text">æ™‚é–“</label><input type="time" v-model="editForm.time" class="input-field"></div><div><label class="label-text">äº¤é€šæ™‚é–“(åˆ†)</label><input type="number" v-model="editForm.transportTime" class="input-field"></div></div>
                    <div><label class="label-text">äº¤é€šæ–¹å¼</label><select v-model="editForm.transportType" class="input-field"><option value="walk">æ­¥è¡Œ</option><option value="train">å¤§çœ¾é‹è¼¸</option><option value="car">é–‹è»Š/æ¥é€</option></select></div>
                    <div><label class="label-text">è²»ç”¨ / é–€ç¥¨</label><input type="text" v-model="editForm.ticket" class="input-field" placeholder="ä¾‹å¦‚ï¼š600å††"></div>
                    <div><label class="label-text">å‚™è¨»</label><textarea v-model="editForm.note" class="input-field h-20"></textarea></div>
                    <div>
                        <label class="label-text flex justify-between items-center"><span>åœ–ç‰‡ (å¯å¤šé¸)</span><span v-if="isCompressing" class="text-sakura-red text-xs flex items-center"><div class="loader mr-1"></div>è™•ç†ä¸­...</span></label>
                        <div class="grid grid-cols-3 sm:grid-cols-4 gap-3">
                            <div v-for="(img, idx) in editForm.images" :key="idx" class="relative aspect-square group">
                                <img :src="img" class="w-full h-full object-cover rounded-xl border border-gray-200">
                                <button @click="removeImage(idx)" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full shadow-md flex items-center justify-center transform hover:scale-110 transition-transform"><i class="fa-solid fa-times text-xs"></i></button>
                            </div>
                            <label class="aspect-square bg-gray-50 rounded-xl flex flex-col items-center justify-center cursor-pointer border-2 border-dashed border-gray-300 hover:border-sakura-red hover:bg-red-50 transition-all">
                                <i class="fa-solid fa-camera text-gray-400 text-xl mb-1"></i><span class="text-[10px] text-gray-400">æ–°å¢</span>
                                <input type="file" @change="handleItineraryImageUpload" class="hidden" accept="image/*" multiple>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-4 mt-8 shrink-0">
                    <button v-if="isEditing" @click="confirmDelete" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-500 py-3.5 rounded-xl font-bold transition-colors">åˆªé™¤</button>
                    <button @click="saveItinerary" :disabled="isCompressing" class="flex-[2] bg-sakura-red hover:bg-sakura-dark text-white py-3.5 rounded-xl font-bold shadow-lg shadow-red-100 transition-colors disabled:bg-gray-400">{{ isCompressing ? 'è™•ç†ä¸­...' : 'å„²å­˜' }}</button>
                </div>
            </div>
        </div>

        <div v-if="showShoppingModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" @click.self="showShoppingModal = false">
            <div class="bg-white w-full max-w-md rounded-2xl p-8 m-4 shadow-2xl">
                <h3 class="font-bold text-xl mb-6 text-center">æ–°å¢è³¼ç‰©</h3>
                <input type="text" v-model="newShoppingItem.name" class="input-field mb-6" placeholder="å•†å“åç¨±">
                <label class="block w-full h-40 border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-sakura-red bg-gray-50">
                    <img v-if="newShoppingItem.image" :src="newShoppingItem.image" class="h-full object-contain">
                    <div v-else class="text-center text-gray-400"><i class="fa-solid fa-camera text-2xl mb-2"></i><br>ä¸Šå‚³åœ–ç‰‡</div>
                    <input type="file" @change="handleShoppingImageUpload" class="hidden" accept="image/*">
                </label>
                <button @click="saveShoppingItem" class="w-full bg-sakura-red text-white py-3.5 rounded-xl font-bold mt-6 hover:bg-sakura-dark">åŠ å…¥</button>
            </div>
        </div>
        
        <div v-if="showExpenseModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50" @click.self="showExpenseModal = false">
             <div class="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl p-8 shadow-2xl">
                <h3 class="font-bold text-xl mb-6 text-center">è¨˜å¸³</h3>
                <div class="space-y-4">
                    <select v-model="newExpense.category" class="input-field"><option>é£²é£Ÿ</option><option>äº¤é€š</option><option>è³¼ç‰©</option><option>é–€ç¥¨</option><option>ä½å®¿</option><option>å…¶ä»–</option></select>
                    <input type="text" v-model="newExpense.name" class="input-field" placeholder="é …ç›®">
                    <input type="number" v-model="newExpense.amount" class="input-field" placeholder="é‡‘é¡">
                    <div class="flex space-x-3"><button @click="newExpense.method='ç¾é‡‘'" :class="['flex-1 py-2 rounded-lg border', newExpense.method==='ç¾é‡‘'?'bg-sakura-red text-white':'bg-white']">ç¾é‡‘</button><button @click="newExpense.method='ä¿¡ç”¨å¡'" :class="['flex-1 py-2 rounded-lg border', newExpense.method==='ä¿¡ç”¨å¡'?'bg-sakura-red text-white':'bg-white']">ä¿¡ç”¨å¡</button></div>
                    <input type="date" v-model="newExpense.date" class="input-field">
                </div>
                <button @click="saveExpense" class="w-full bg-sakura-red text-white py-3.5 rounded-xl font-bold mt-6 hover:bg-sakura-dark">å„²å­˜</button>
             </div>
        </div>

        <div v-if="showHotelModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50" @click.self="showHotelModal = false">
            <div class="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl p-8 shadow-2xl slide-up-animation">
               <h3 class="font-bold text-xl mb-6 text-center">æ–°å¢ä½å®¿</h3>
               <div class="space-y-4">
                   <div><label class="label-text">é£¯åº—åç¨±</label><input type="text" v-model="hotelForm.name" class="input-field" placeholder="ä¾‹å¦‚ï¼šBRACKETS HOTEL"></div>
                   <div><label class="label-text">å…¥ä½æ—¥æœŸ/å¤©æ•¸</label><input type="text" v-model="hotelForm.dates" class="input-field" placeholder="ä¾‹å¦‚ï¼š4/11 - 4/14"></div>
                   <div class="grid grid-cols-2 gap-4"><div><label class="label-text">å…¥ä½æ™‚é–“</label><input type="time" v-model="hotelForm.checkIn" class="input-field"></div><div><label class="label-text">é€€æˆ¿æ™‚é–“</label><input type="time" v-model="hotelForm.checkOut" class="input-field"></div></div>
               </div>
               <button @click="saveHotel" class="w-full bg-sakura-red text-white py-3.5 rounded-xl font-bold mt-6 hover:bg-sakura-dark">å„²å­˜ä½å®¿</button>
            </div>
       </div>

        <div v-if="showFoodModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" @click.self="showFoodModal = false">
            <div class="bg-white w-full max-w-md rounded-2xl p-8 m-4 shadow-2xl slide-up-animation">
                <h3 class="font-bold text-xl mb-6 text-center">æ–°å¢ç¾é£Ÿ</h3>
                <div class="space-y-4">
                    <div>
                        <label class="label-text">åœ°å€åˆ†é¡</label>
                        <div class="flex space-x-3">
                            <button @click="newFoodItem.category = 'osaka'" :class="['flex-1 py-3 rounded-xl border font-bold transition-all', newFoodItem.category === 'osaka' ? 'bg-blue-500 text-white border-blue-500 shadow-md' : 'bg-white border-gray-200 text-gray-500']"><i class="fa-solid fa-city mr-2"></i>å¤§é˜ª</button>
                            <button @click="newFoodItem.category = 'kyoto'" :class="['flex-1 py-3 rounded-xl border font-bold transition-all', newFoodItem.category === 'kyoto' ? 'bg-red-500 text-white border-red-500 shadow-md' : 'bg-white border-gray-200 text-gray-500']"><i class="fa-solid fa-torii-gate mr-2"></i>äº¬éƒ½</button>
                        </div>
                    </div>
                    <div><label class="label-text">åº—å / é¤å»³åç¨±</label><input type="text" v-model="newFoodItem.name" class="input-field" placeholder="ä¾‹å¦‚ï¼šæ•˜æ•˜è‹‘ç‡’è‚‰"></div>
                    <div><label class="label-text">å‚™è¨» / å¿…åƒé¤é»</label><textarea v-model="newFoodItem.note" class="input-field h-20" placeholder="ä¾‹å¦‚ï¼šç‰›èˆŒå¿…é»"></textarea></div>
                    <label class="block w-full h-32 border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-sakura-red bg-gray-50">
                        <img v-if="newFoodItem.image" :src="newFoodItem.image" class="h-full object-contain">
                        <div v-else class="text-center text-gray-400"><i class="fa-solid fa-camera text-2xl mb-2"></i><br>ä¸Šå‚³åœ–ç‰‡</div>
                        <input type="file" @change="handleFoodImageUpload" class="hidden" accept="image/*">
                    </label>
                </div>
                <button @click="saveFoodItem" class="w-full bg-sakura-red text-white py-3.5 rounded-xl font-bold mt-6 hover:bg-sakura-dark">åŠ å…¥æ¸…å–®</button>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, reactive, watch } = Vue;

        createApp({
            setup() {
                localforage.config({ name: 'TripApp', storeName: 'trip_data' });

                const currentTab = ref('itinerary');
                const currentDayIndex = ref(0);
                const showEditModal = ref(false), showShoppingModal = ref(false), showExpenseModal = ref(false), showHotelModal = ref(false), showFoodModal = ref(false);
                const isEditing = ref(false), editingIndex = ref(-1), isCompressing = ref(false), isLoadingData = ref(true);

                const days = [
                    { date: '11', week: 'Fri', fullDate: '2026-04-11', location: 'å¤§é˜ª', lat: 34.6937, lng: 135.5023 },
                    { date: '12', week: 'Sat', fullDate: '2026-04-12', location: 'å¤§é˜ª', lat: 34.6937, lng: 135.5023 },
                    { date: '13', week: 'Sun', fullDate: '2026-04-13', location: 'ç’°çƒå½±åŸ', lat: 34.6654, lng: 135.4323 },
                    { date: '14', week: 'Mon', fullDate: '2026-04-14', location: 'å¤§é˜ª/äº¬éƒ½', lat: 35.0116, lng: 135.7681 },
                    { date: '15', week: 'Tue', fullDate: '2026-04-15', location: 'äº¬éƒ½', lat: 35.0116, lng: 135.7681 },
                    { date: '16', week: 'Wed', fullDate: '2026-04-16', location: 'äº¬éƒ½', lat: 35.0116, lng: 135.7681 },
                    { date: '17', week: 'Thu', fullDate: '2026-04-17', location: 'äº¬éƒ½/å¤§é˜ª', lat: 34.6937, lng: 135.5023 },
                    { date: '18', week: 'Fri', fullDate: '2026-04-18', location: 'å¤§é˜ª/å º', lat: 34.5733, lng: 135.4830 },
                    { date: '19', week: 'Sat', fullDate: '2026-04-19', location: 'é—œè¥¿æ©Ÿå ´', lat: 34.4320, lng: 135.2304 }
                ];
                
                const defaultHotels = [
                    { dates: '4/11-14', name: 'BRACKETS HOTEL', checkIn: '15:00', checkOut: '11:00' }, 
                    { dates: '4/14-17', name: 'Ms Hotel', checkIn: '16:00', checkOut: '10:00' }, 
                    { dates: '4/17-18', name: 'Hotel Meldia', checkIn: '15:00', checkOut: '11:00' }, 
                    { dates: '4/18-19', name: 'EZ HOTEL', checkIn: '15:00', checkOut: '10:00' }
                ];
                const defaultItinerary = { 0: [{ id: 1, category: 'flight', name: 'TPE -> KIX', time: '18:00', note: 'æŠµé”é—œè¥¿', transportTime: 0, transportType: 'car', isFlight: true, images: [] }] };

                const itineraryData = reactive({});
                const shoppingList = ref([]);
                const expenses = ref([]);
                const hotels = ref([]); 
                const foodList = ref([]); // ç¾é£Ÿæ¸…å–®è³‡æ–™
                const weather = reactive({ temp: '--', code: 0, desc: 'è¼‰å…¥ä¸­...', iconClass: 'fa-solid fa-cloud', loading: false });

                const editForm = reactive({ id: null, category: 'spot', name: '', time: '', note: '', ticket: '', transportTime: 30, transportType: 'train', images: [], image: null });
                const newShoppingItem = reactive({ name: '', image: null, checked: false });
                const newExpense = reactive({ category: 'é£²é£Ÿ', name: '', amount: '', method: 'ç¾é‡‘', date: new Date().toISOString().split('T')[0] });
                const hotelForm = reactive({ name: '', dates: '', checkIn: '15:00', checkOut: '11:00' });
                const newFoodItem = reactive({ name: '', category: 'osaka', note: '', image: null }); // ç¾é£Ÿè¡¨å–®

                const calcInput = ref('');
                const calcFormula = ref('');
                const calcResultTwd = computed(() => {
                    try {
                        if (!calcInput.value) return 0;
                        const safeExpr = calcInput.value.replace(/[^0-9+\-*/.]/g, '');
                        if(!safeExpr) return 0;
                        const jpyResult = new Function('return ' + safeExpr)();
                        return Math.round(jpyResult * 0.22).toLocaleString();
                    } catch (e) { return '...'; }
                });

                const appendCalc = (val) => { calcInput.value += val; };
                const clearCalc = () => { calcInput.value = ''; calcFormula.value = ''; };
                const calculateFinal = () => {
                    try {
                        const safeExpr = calcInput.value.replace(/[^0-9+\-*/.]/g, '');
                        if(!safeExpr) return;
                        const result = new Function('return ' + safeExpr)();
                        calcFormula.value = calcInput.value + ' =';
                        calcInput.value = String(result);
                    } catch(e) { calcInput.value = 'Error'; }
                };

                const getCategoryColor = (cat) => ({ spot: 'border-pink-400', food: 'border-orange-400', shopping: 'border-purple-400', flight: 'border-blue-400', hotel: 'border-indigo-400' }[cat] || 'border-gray-400');
                const getCategoryBg = (cat) => ({ spot: 'bg-pink-400', food: 'bg-orange-400', shopping: 'bg-purple-400', flight: 'bg-blue-400', hotel: 'bg-indigo-400' }[cat] || 'bg-gray-400');
                const getCategoryIcon = (cat) => ({ spot: 'fa-solid fa-camera', food: 'fa-solid fa-utensils', shopping: 'fa-solid fa-bag-shopping', flight: 'fa-solid fa-plane', hotel: 'fa-solid fa-bed' }[cat] || 'fa-solid fa-star');
                const getTransportIcon = (t) => t === 'walk' ? 'fa-solid fa-person-walking' : t === 'car' ? 'fa-solid fa-car' : 'fa-solid fa-train-subway';
                const getExpenseIcon = (c) => ({ 'é£²é£Ÿ': 'fa-solid fa-utensils', 'äº¤é€š': 'fa-solid fa-train', 'è³¼ç‰©': 'fa-solid fa-bag-shopping', 'é–€ç¥¨': 'fa-solid fa-ticket' }[c] || 'fa-solid fa-receipt');
                const getTabIcon = (t) => ({ 'itinerary': 'fa-solid fa-map-location-dot', 'info': 'fa-solid fa-circle-info', 'shopping': 'fa-solid fa-basket-shopping', 'expenses': 'fa-solid fa-coins', 'food': 'fa-solid fa-utensils' }[t]);

                const getWeatherIconClass = (code) => {
                    if (code === 0) return 'fa-solid fa-sun text-yellow-400';
                    if (code === 1 || code === 2 || code === 3) return 'fa-solid fa-cloud-sun text-yellow-300';
                    if (code === 45 || code === 48) return 'fa-solid fa-smog text-gray-400';
                    if (code >= 51 && code <= 67) return 'fa-solid fa-cloud-rain text-blue-400';
                    if (code >= 71 && code <= 77) return 'fa-regular fa-snowflake text-blue-200';
                    if (code >= 95) return 'fa-solid fa-bolt text-purple-500';
                    return 'fa-solid fa-cloud text-gray-400';
                };

                const getWeatherDesc = (code) => {
                    const map = { 0:'æ™´æœ—', 1:'å¤§è‡´æ™´æœ—', 2:'å¤šé›²', 3:'é™°å¤©', 45:'éœ§', 51:'æ¯›æ¯›é›¨', 61:'å°é›¨', 63:'é›¨', 95:'é›·é›¨' };
                    return map[code] || 'å¤šé›²';
                };

                const updateWeather = async () => {
                    weather.loading = true;
                    const day = days[currentDayIndex.value];
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${day.lat}&longitude=${day.lng}&current_weather=true&timezone=Asia%2FTokyo`);
                        const data = await res.json();
                        if(data.current_weather) {
                            weather.temp = data.current_weather.temperature;
                            weather.code = data.current_weather.weathercode;
                            weather.iconClass = getWeatherIconClass(weather.code);
                            weather.desc = getWeatherDesc(weather.code);
                        }
                    } catch (e) {
                        console.error('Weather error:', e);
                        weather.temp = 'N/A';
                    } finally {
                        weather.loading = false;
                    }
                };

                watch(currentTab, (newVal) => {
                    if (newVal === 'itinerary') nextTick(() => initSortable());
                });

                watch(currentDayIndex, () => {
                    updateWeather();
                    nextTick(() => initSortable());
                });

                const loadData = async () => {
                    try {
                        isLoadingData.value = true;
                        
                        const dbItinerary = await localforage.getItem('itineraryData');
                        const dbShopping = await localforage.getItem('shoppingList');
                        const dbExpenses = await localforage.getItem('expenses');
                        const dbHotels = await localforage.getItem('hotels'); 
                        const dbFood = await localforage.getItem('foodList'); // è¼‰å…¥ç¾é£Ÿ

                        shoppingList.value = Array.isArray(dbShopping) ? dbShopping : [];
                        expenses.value = Array.isArray(dbExpenses) ? dbExpenses : [];
                        hotels.value = Array.isArray(dbHotels) ? dbHotels : defaultHotels; 
                        foodList.value = Array.isArray(dbFood) ? dbFood : []; // åˆå§‹åŒ–ç¾é£Ÿæ¸…å–®
                        
                        if (!dbItinerary) {
                             const oldIt = localStorage.getItem('itineraryData');
                             if(oldIt) {
                                 try { const parsed = JSON.parse(oldIt); Object.assign(itineraryData, parsed); } 
                                 catch(e) { Object.assign(itineraryData, defaultItinerary); }
                             } else { Object.assign(itineraryData, defaultItinerary); }
                        } else {
                            Object.assign(itineraryData, dbItinerary);
                        }
                        
                        updateWeather();

                    } catch (e) {
                        console.error('Data load error:', e);
                        Object.assign(itineraryData, defaultItinerary);
                        shoppingList.value = [];
                        expenses.value = [];
                        hotels.value = defaultHotels;
                        foodList.value = [];
                    } finally {
                        isLoadingData.value = false;
                        nextTick(() => initSortable());
                    }
                };

                onMounted(loadData);

                const saveToDB = async () => {
                    try {
                        await localforage.setItem('itineraryData', JSON.parse(JSON.stringify(itineraryData)));
                        await localforage.setItem('shoppingList', JSON.parse(JSON.stringify(shoppingList.value)));
                        await localforage.setItem('expenses', JSON.parse(JSON.stringify(expenses.value)));
                        await localforage.setItem('hotels', JSON.parse(JSON.stringify(hotels.value))); 
                        await localforage.setItem('foodList', JSON.parse(JSON.stringify(foodList.value))); // å„²å­˜ç¾é£Ÿ
                    } catch (e) {
                        alert("å„²å­˜å¤±æ•—: " + e.message);
                    }
                };

                const currentDayItinerary = computed(() => itineraryData[currentDayIndex.value] || []);
                const totalExpenses = computed(() => (expenses.value || []).reduce((sum, item) => sum + Number(item.amount || 0), 0));
                const cashExpenses = computed(() => (expenses.value || []).filter(i => i.method === 'ç¾é‡‘').reduce((sum, item) => sum + Number(item.amount || 0), 0));
                const cardExpenses = computed(() => (expenses.value || []).filter(i => i.method === 'ä¿¡ç”¨å¡').reduce((sum, item) => sum + Number(item.amount || 0), 0));
                
                // ç¾é£Ÿæ¸…å–®åˆ†é¡
                const osakaFoods = computed(() => foodList.value.filter(f => f.category === 'osaka'));
                const kyotoFoods = computed(() => foodList.value.filter(f => f.category === 'kyoto'));

                const compressImage = (file) => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = (e) => {
                            const img = new Image();
                            img.src = e.target.result;
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                const MAX_WIDTH = 800; 
                                let width = img.width;
                                let height = img.height;
                                if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                                canvas.width = width; canvas.height = height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, width, height);
                                resolve(canvas.toDataURL('image/jpeg', 0.7));
                            };
                        };
                    });
                };

                const handleItineraryImageUpload = async (e) => {
                    const files = e.target.files;
                    if (files && files.length > 0) {
                        isCompressing.value = true;
                        if (!editForm.images) editForm.images = [];
                        try {
                            for (let file of files) {
                                const compressed = await compressImage(file);
                                editForm.images.push(compressed);
                            }
                        } catch(err) { alert('åœ–ç‰‡è™•ç†å¤±æ•—'); }
                        finally { isCompressing.value = false; }
                    }
                };
                
                const handleShoppingImageUpload = async (e) => {
                    if (e.target.files[0]) {
                        newShoppingItem.image = await compressImage(e.target.files[0]);
                    }
                };

                const handleFoodImageUpload = async (e) => {
                    if (e.target.files[0]) {
                        newFoodItem.image = await compressImage(e.target.files[0]);
                    }
                };

                const handleFabClick = () => {
                    if (currentTab.value === 'itinerary') openAddModal();
                    else if (currentTab.value === 'shopping') showShoppingModal.value = true;
                    else if (currentTab.value === 'expenses') showExpenseModal.value = true;
                    else if (currentTab.value === 'info') { 
                        hotelForm.name = ''; hotelForm.dates = ''; hotelForm.checkIn = '15:00'; hotelForm.checkOut = '11:00';
                        showHotelModal.value = true;
                    } else if (currentTab.value === 'food') { // é–‹å•Ÿç¾é£Ÿ Modal
                        newFoodItem.name = ''; newFoodItem.note = ''; newFoodItem.image = null; newFoodItem.category = 'osaka';
                        showFoodModal.value = true;
                    }
                };

                const openAddModal = () => { 
                    isEditing.value = false; 
                    Object.assign(editForm, { id: Date.now(), category: 'spot', name: '', time: '10:00', note: '', ticket: '', transportTime: 30, transportType: 'train', images: [], image: null }); 
                    showEditModal.value = true; 
                };
                
                const editItem = (item, idx) => { 
                    isEditing.value = true; 
                    editingIndex.value = idx; 
                    const copy = JSON.parse(JSON.stringify(item)); 
                    if(copy.image && (!copy.images || copy.images.length === 0)) copy.images = [copy.image];
                    if(!copy.images) copy.images = [];
                    Object.assign(editForm, copy); 
                    showEditModal.value = true; 
                };
                
                const saveItinerary = async () => {
                    editForm.icon = getCategoryIcon(editForm.category); 
                    if(editForm.images.length > 0) editForm.image = editForm.images[0]; 
                    else editForm.image = null;

                    if (!itineraryData[currentDayIndex.value]) itineraryData[currentDayIndex.value] = [];
                    if (isEditing.value) itineraryData[currentDayIndex.value][editingIndex.value] = { ...editForm };
                    else itineraryData[currentDayIndex.value].push({ ...editForm });
                    await saveToDB(); 
                    showEditModal.value = false;
                };

                const saveHotel = async () => {
                    if (hotelForm.name) {
                        hotels.value.push({ ...hotelForm, id: Date.now() });
                        await saveToDB();
                        showHotelModal.value = false;
                    }
                };

                const saveFoodItem = async () => {
                    if (newFoodItem.name) {
                        foodList.value.push({ ...newFoodItem, id: Date.now() });
                        await saveToDB();
                        showFoodModal.value = false;
                    }
                };

                const deleteHotel = async (idx) => { if(confirm('ç¢ºå®šåˆªé™¤æ­¤ä½å®¿ï¼Ÿ')) { hotels.value.splice(idx, 1); await saveToDB(); } };
                const deleteFoodItem = async (id) => { if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç¾é£Ÿï¼Ÿ')) { const idx = foodList.value.findIndex(f => f.id === id); if(idx !== -1) { foodList.value.splice(idx, 1); await saveToDB(); } } };

                const confirmDelete = async () => { if(confirm('åˆªé™¤?')) { itineraryData[currentDayIndex.value].splice(editingIndex.value, 1); await saveToDB(); showEditModal.value = false; } };
                const removeImage = (idx) => editForm.images.splice(idx, 1);
                
                const saveShoppingItem = async () => { if(newShoppingItem.name) { shoppingList.value.push({...newShoppingItem}); await saveToDB(); showShoppingModal.value = false; newShoppingItem.name=''; newShoppingItem.image=null; }};
                const deleteShoppingItem = async (idx) => { shoppingList.value.splice(idx, 1); await saveToDB(); };
                
                const saveExpense = async () => { if(newExpense.amount) { expenses.value.unshift({...newExpense}); await saveToDB(); showExpenseModal.value = false; newExpense.name=''; newExpense.amount=''; }};
                const deleteExpense = async (idx) => { if(confirm('åˆªé™¤?')) { expenses.value.splice(idx, 1); await saveToDB(); } };
                
                const openMap = (l) => window.open(`https://www.google.com/maps/search/?api=1&query=?q=${encodeURIComponent(l)}`, '_blank');
                const openImage = (u) => window.open(u, '_blank');
                const closeModal = () => showEditModal.value = false;

                const initSortable = () => {
                    const el = document.getElementById('itinerary-list');
                    if (el) {
                        if(el._sortable) el._sortable.destroy();
                        el._sortable = Sortable.create(el, {
                            handle: '.handle', 
                            animation: 250,
                            forceFallback: true,      
                            fallbackClass: "sortable-fallback",
                            fallbackOnBody: true,     
                            delay: 150,               
                            delayOnTouchOnly: true,   
                            touchStartThreshold: 5,   
                            ghostClass: 'sortable-ghost',
                            onEnd: async (evt) => {
                                if (evt.oldIndex === evt.newIndex) return;
                                const list = itineraryData[currentDayIndex.value];
                                const item = list.splice(evt.oldIndex, 1)[0];
                                list.splice(evt.newIndex, 0, item);
                                await saveToDB();
                            }
                        });
                    }
                };
                
                return {
                    currentTab, currentDayIndex, days, hotels, currentDayItinerary, totalExpenses, cashExpenses, cardExpenses,
                    showEditModal, showShoppingModal, showExpenseModal, showHotelModal, showFoodModal, 
                    editForm, newShoppingItem, newExpense, hotelForm, newFoodItem,
                    isEditing, isCompressing, isLoadingData,
                    getCategoryColor, getCategoryBg, getCategoryIcon, getTransportIcon, getExpenseIcon, getTabIcon,
                    handleFabClick, openAddModal, editItem, saveItinerary, confirmDelete, closeModal,
                    saveShoppingItem, deleteShoppingItem, handleShoppingImageUpload,
                    saveExpense, deleteExpense, saveHotel, deleteHotel,
                    saveFoodItem, deleteFoodItem, handleFoodImageUpload, osakaFoods, kyotoFoods, foodList,
                    openMap, openImage, handleItineraryImageUpload, removeImage,
                    weather, calcInput, calcFormula, calcResultTwd, appendCalc, clearCalc, calculateFinal
                };
            }
        }).mount('#app');
    </script>
    <style>.label-text { @apply block text-xs font-bold text-gray-400 mb-1 ml-1; } .input-field { @apply w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-sakura-red focus:bg-white transition-colors; } .slide-up-animation { animation: slideUp 0.3s ease-out; } @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }</style>
</body>
</html>
