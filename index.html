<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>關西之旅 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sakura: {
                            light: '#fff0f5', // 淺粉背景
                            main: '#ffb7b2',  // 櫻花主色
                            dark: '#ff9e99',
                            red: '#e94e59',   // 重點紅
                            text: '#4a4a4a'
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #fdfbfb;
            color: #4a4a4a;
            -webkit-tap-highlight-color: transparent;
        }
        /* 隱藏滾動條但保留功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* 卡片陰影 */
        .card-shadow {
            box-shadow: 0 4px 20px rgba(233, 78, 89, 0.08);
        }
        /* 櫻花飄落背景 */
        .sakura-bg {
            background-image: url('https://www.transparenttextures.com/patterns/flower-trail.png');
            background-size: 400px;
            background-attachment: fixed;
        }
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
        /* 文字陰影，讓字在圖片上更清楚 */
        .text-shadow {
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="sakura-bg h-screen overflow-hidden flex flex-col font-sans">

    <div id="app" class="h-full flex flex-col max-w-md mx-auto bg-white/90 shadow-2xl relative">
        
        <header class="relative h-[250px] bg-gray-200 overflow-hidden shrink-0 group">
            
            <img src="./banner.png" 
                 alt="Trip Banner" 
                 class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                 onerror="this.src='https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?q=80&w=2070&auto=format&fit=crop';">
            
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>

            <div class="absolute bottom-4 left-6 z-10 text-white">
                <h1 class="text-4xl font-bold tracking-widest text-shadow">京阪奈</h1>
                <p class="text-sm font-medium opacity-90 mt-1 text-shadow"><i class="fa-regular fa-calendar mr-2"></i>2026.04.11 - 04.19</p>
            </div>

            <div class="absolute bottom-4 right-4 flex space-x-3 z-20">
                <button @click="currentTab = 'itinerary'" :class="['w-10 h-10 rounded-full flex items-center justify-center transition-all shadow-lg backdrop-blur-sm', currentTab === 'itinerary' ? 'bg-sakura-red text-white scale-110' : 'bg-white/80 text-gray-500 hover:bg-white']">
                    <i class="fa-solid fa-map-location-dot"></i>
                </button>
                <button @click="currentTab = 'info'" :class="['w-10 h-10 rounded-full flex items-center justify-center transition-all shadow-lg backdrop-blur-sm', currentTab === 'info' ? 'bg-sakura-red text-white scale-110' : 'bg-white/80 text-gray-500 hover:bg-white']">
                    <i class="fa-solid fa-circle-info"></i>
                </button>
                <button @click="currentTab = 'shopping'" :class="['w-10 h-10 rounded-full flex items-center justify-center transition-all shadow-lg backdrop-blur-sm', currentTab === 'shopping' ? 'bg-sakura-red text-white scale-110' : 'bg-white/80 text-gray-500 hover:bg-white']">
                    <i class="fa-solid fa-basket-shopping"></i>
                </button>
                <button @click="currentTab = 'expenses'" :class="['w-10 h-10 rounded-full flex items-center justify-center transition-all shadow-lg backdrop-blur-sm', currentTab === 'expenses' ? 'bg-sakura-red text-white scale-110' : 'bg-white/80 text-gray-500 hover:bg-white']">
                    <i class="fa-solid fa-coins"></i>
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar relative bg-gray-50/50 pb-20">
            
            <div v-if="currentTab === 'itinerary'" class="h-full flex flex-col">
                <div class="bg-white/80 backdrop-blur sticky top-0 z-30 shadow-sm border-b border-gray-100 py-3">
                    <div class="flex overflow-x-auto no-scrollbar px-4 space-x-4">
                        <div v-for="(day, index) in days" :key="index" 
                             @click="currentDayIndex = index"
                             :class="['flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-xl transition-all cursor-pointer', currentDayIndex === index ? 'bg-sakura-red text-white shadow-lg transform -translate-y-1' : 'bg-white text-gray-400 border border-gray-100']">
                            <span class="text-xs font-medium">{{ day.week }}</span>
                            <span class="text-xl font-bold">{{ day.date }}</span>
                        </div>
                    </div>
                </div>

                <div class="mx-4 mt-4 p-4 bg-gradient-to-r from-blue-50 to-white rounded-2xl flex items-center justify-between card-shadow">
                    <div>
                        <div class="text-xs text-gray-400 mb-1">
                            <i class="fa-solid fa-location-dot mr-1"></i>
                            {{ days[currentDayIndex].location }}
                        </div>
                        <div class="flex items-baseline">
                            <span class="text-3xl font-light text-gray-700">18°</span>
                            <span class="text-xs text-gray-400 ml-2">體感 16°</span>
                        </div>
                    </div>
                    <div class="text-center text-blue-300">
                        <i class="fa-solid fa-cloud-sun text-4xl"></i>
                    </div>
                </div>

                <div class="p-4 space-y-0" id="itinerary-list">
                    <div v-for="(item, index) in currentDayItinerary" :key="item.id" class="relative group itinerary-item">
                        
                        <div v-if="index > 0" class="flex items-center justify-center py-2 relative">
                            <div class="h-8 w-0.5 bg-gray-200 absolute top-0 bottom-0 z-0"></div>
                            <div class="bg-white border border-gray-200 text-gray-400 text-xs px-2 py-1 rounded-full z-10 flex items-center space-x-1 cursor-pointer hover:bg-gray-50 shadow-sm">
                                <i :class="getTransportIcon(item.transportType)"></i>
                                <span>{{ item.transportTime }} min</span>
                            </div>
                        </div>
                        <div v-else-if="index === 0 && !item.isFlight" class="flex items-center justify-center py-2 pb-4">
                            <div class="text-xs text-gray-400 bg-gray-100 px-3 py-1 rounded-full">
                                <i class="fa-solid fa-hotel mr-1"></i> 從飯店出發約 {{ item.transportTime }} min
                            </div>
                        </div>

                        <div @click="openMap(item.name)" 
                             :class="['relative bg-white rounded-2xl p-4 card-shadow border-l-4 cursor-pointer active:scale-95 transition-transform', getCategoryColor(item.category)]">
                            
                            <div class="absolute top-4 right-4 text-gray-200 handle cursor-move">
                                <i class="fa-solid fa-grip-lines"></i>
                            </div>

                            <div class="flex items-start">
                                <div :class="['w-10 h-10 rounded-full flex items-center justify-center text-white shrink-0 shadow-md', getCategoryBg(item.category)]">
                                    <i :class="item.icon"></i>
                                </div>
                                
                                <div class="ml-4 flex-1">
                                    <div class="flex justify-between items-baseline pr-6">
                                        <h3 class="font-bold text-gray-700 text-lg">{{ item.name }}</h3>
                                    </div>
                                    <div class="text-sakura-red font-medium text-sm mt-0.5">
                                        {{ item.time }}
                                    </div>

                                    <div class="flex flex-wrap gap-2 mt-2">
                                        <span v-if="item.ticket" class="text-xs bg-yellow-50 text-yellow-600 px-2 py-0.5 rounded border border-yellow-100">
                                            <i class="fa-solid fa-ticket mr-1"></i>{{ item.ticket }}
                                        </span>
                                        <span v-if="item.openTime" class="text-xs bg-gray-50 text-gray-500 px-2 py-0.5 rounded border border-gray-100">
                                            <i class="fa-regular fa-clock mr-1"></i>{{ item.openTime }}
                                        </span>
                                    </div>

                                    <p v-if="item.note" class="text-xs text-gray-500 mt-2 leading-relaxed bg-gray-50 p-2 rounded">
                                        {{ item.note }}
                                    </p>
                                </div>
                            </div>
                            
                            <div class="absolute bottom-2 right-2 flex space-x-2">
                                <button @click.stop="editItem(item, index)" class="text-gray-300 hover:text-blue-400 p-2">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <button @click="openAddModal" class="fixed bottom-24 right-6 w-14 h-14 bg-sakura-red text-white rounded-full shadow-lg shadow-red-200 flex items-center justify-center text-2xl active:scale-90 transition-transform z-50">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div v-if="currentTab === 'info'" class="p-6 space-y-6">
                <div class="bg-white rounded-2xl p-6 card-shadow border-t-4 border-sakura-red">
                    <h3 class="text-lg font-bold text-gray-700 mb-4"><i class="fa-solid fa-calculator mr-2 text-sakura-red"></i>即時匯率</h3>
                    <div class="flex items-center space-x-4 mb-4">
                        <div class="flex-1">
                            <label class="text-xs text-gray-400 block mb-1">日幣 (JPY)</label>
                            <input type="number" v-model="calcJpy" class="w-full text-2xl font-bold border-b border-gray-200 focus:border-sakura-red outline-none py-1" placeholder="0">
                        </div>
                        <i class="fa-solid fa-arrow-right-arrow-left text-gray-300"></i>
                        <div class="flex-1">
                            <label class="text-xs text-gray-400 block mb-1">台幣 (TWD)</label>
                            <div class="text-2xl font-bold text-gray-700 py-1">{{ calcTwd }}</div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 text-right">匯率基準: 0.22</p>
                </div>

                <div class="bg-white rounded-2xl p-6 card-shadow">
                    <h3 class="text-lg font-bold text-gray-700 mb-4"><i class="fa-solid fa-plane-departure mr-2 text-blue-400"></i>航班資訊</h3>
                    <div class="space-y-4">
                        <div class="border-l-2 border-blue-400 pl-4">
                            <div class="text-xs text-gray-400">去程 4/11 (五)</div>
                            <div class="flex justify-between items-end">
                                <span class="text-xl font-bold">TPE</span>
                                <i class="fa-solid fa-plane text-gray-300 text-sm mx-2"></i>
                                <span class="text-xl font-bold">KIX</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600 mt-1">
                                <span>18:00</span>
                                <span>22:00</span>
                            </div>
                        </div>
                        <div class="border-l-2 border-sakura-red pl-4">
                            <div class="text-xs text-gray-400">回程 4/19 (六)</div>
                            <div class="flex justify-between items-end">
                                <span class="text-xl font-bold">KIX</span>
                                <i class="fa-solid fa-plane text-gray-300 text-sm mx-2"></i>
                                <span class="text-xl font-bold">KHH</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600 mt-1">
                                <span>10:45</span>
                                <span>13:10</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-6 card-shadow">
                    <h3 class="text-lg font-bold text-gray-700 mb-4"><i class="fa-solid fa-bed mr-2 text-purple-400"></i>住宿資訊</h3>
                    <div v-for="hotel in hotels" :key="hotel.name" class="mb-4 pb-4 border-b border-gray-100 last:border-0 last:pb-0">
                        <div class="text-xs text-sakura-red mb-1">{{ hotel.dates }}</div>
                        <div class="font-bold text-gray-800">{{ hotel.name }}</div>
                        <div class="flex space-x-3 mt-2">
                            <a :href="'https://www.google.com/maps/search/?api=1&query=' + hotel.name" target="_blank" class="flex-1 bg-gray-100 text-center py-2 rounded text-sm text-gray-600"><i class="fa-solid fa-location-arrow mr-1"></i>導航</a>
                            <a href="#" class="flex-1 bg-gray-100 text-center py-2 rounded text-sm text-gray-600"><i class="fa-solid fa-phone mr-1"></i>電話</a>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'shopping'" class="p-4 grid grid-cols-2 gap-4">
                <div v-for="(item, index) in shoppingList" :key="index" class="bg-white rounded-xl card-shadow overflow-hidden relative group">
                    <div class="h-32 bg-gray-100 flex items-center justify-center overflow-hidden">
                        <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                        <i v-else class="fa-solid fa-camera text-gray-300 text-2xl"></i>
                    </div>
                    <div class="p-3">
                        <h4 class="font-bold text-gray-700 truncate">{{ item.name }}</h4>
                        <div class="flex items-center justify-between mt-2">
                            <input type="checkbox" v-model="item.checked" class="w-5 h-5 accent-sakura-red">
                            <button @click="deleteShoppingItem(index)" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                </div>
                
                <button @click="openShoppingModal" class="fixed bottom-24 right-6 w-14 h-14 bg-sakura-red text-white rounded-full shadow-lg shadow-red-200 flex items-center justify-center text-2xl z-50">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div v-if="currentTab === 'expenses'" class="flex flex-col h-full">
                <div class="bg-white p-6 m-4 rounded-2xl card-shadow text-center">
                    <p class="text-sm text-gray-400">總支出 (JPY)</p>
                    <div class="text-4xl font-bold text-sakura-red mt-2">¥ {{ totalExpenses.toLocaleString() }}</div>
                    <div class="mt-4 flex justify-center space-x-4 text-xs text-gray-500">
                        <span><i class="fa-solid fa-money-bill mr-1"></i>現金: {{ cashExpenses.toLocaleString() }}</span>
                        <span><i class="fa-regular fa-credit-card mr-1"></i>信用卡: {{ cardExpenses.toLocaleString() }}</span>
                    </div>
                </div>

                <div class="flex-1 px-4 pb-20 space-y-3">
                    <div v-for="(exp, index) in expenses" :key="index" class="bg-white p-4 rounded-xl flex justify-between items-center card-shadow">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-500 mr-3">
                                <i :class="getExpenseIcon(exp.category)"></i>
                            </div>
                            <div>
                                <div class="font-bold text-gray-700">{{ exp.name }}</div>
                                <div class="text-xs text-gray-400">{{ exp.date }} · {{ exp.category }}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold">¥ {{ exp.amount }}</div>
                            <div class="text-xs text-gray-400">{{ exp.method }}</div>
                        </div>
                        <button @click="deleteExpense(index)" class="ml-3 text-gray-200 hover:text-red-400"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>

                <button @click="openExpenseModal" class="fixed bottom-24 right-6 w-14 h-14 bg-sakura-red text-white rounded-full shadow-lg shadow-red-200 flex items-center justify-center text-2xl z-50">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>
        </main>

        <div v-if="showEditModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="closeModal">
            <div class="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl p-6 slide-up-animation">
                <h3 class="text-xl font-bold mb-4 text-center">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
                
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    <div>
                        <label class="label-text">分類</label>
                        <select v-model="editForm.category" class="input-field">
                            <option value="spot">景點</option>
                            <option value="food">美食</option>
                            <option value="shopping">購物</option>
                            <option value="hotel">住宿</option>
                            <option value="flight">航班</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    <div>
                        <label class="label-text">名稱</label>
                        <input type="text" v-model="editForm.name" class="input-field" placeholder="行程名稱">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="label-text">時間</label>
                            <input type="time" v-model="editForm.time" class="input-field">
                        </div>
                         <div>
                            <label class="label-text">交通時間(分)</label>
                            <input type="number" v-model="editForm.transportTime" class="input-field" placeholder="30">
                        </div>
                    </div>
                     <div>
                        <label class="label-text">交通方式</label>
                        <select v-model="editForm.transportType" class="input-field">
                            <option value="walk">步行</option>
                            <option value="train">大眾運輸</option>
                            <option value="car">開車/接送</option>
                        </select>
                    </div>
                    <div v-if="editForm.category === 'spot'">
                         <label class="label-text">門票</label>
                        <input type="text" v-model="editForm.ticket" class="input-field" placeholder="費用或預約資訊">
                    </div>
                    <div>
                        <label class="label-text">備註/營業時間</label>
                        <textarea v-model="editForm.note" class="input-field h-20"></textarea>
                    </div>
                </div>

                <div class="flex space-x-3 mt-6">
                    <button v-if="isEditing" @click="confirmDelete" class="flex-1 bg-gray-100 text-gray-500 py-3 rounded-xl font-bold">刪除</button>
                    <button @click="saveItinerary" class="flex-[2] bg-sakura-red text-white py-3 rounded-xl font-bold shadow-lg shadow-red-100">儲存</button>
                </div>
            </div>
        </div>

        <div v-if="showShoppingModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" @click.self="showShoppingModal = false">
            <div class="bg-white w-5/6 max-w-sm rounded-2xl p-6">
                <h3 class="font-bold text-lg mb-4">新增購物清單</h3>
                <input type="text" v-model="newShoppingItem.name" class="input-field mb-4" placeholder="商品名稱">
                <label class="block w-full h-32 border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center text-gray-400 cursor-pointer hover:border-sakura-red hover:text-sakura-red transition-colors">
                    <i class="fa-solid fa-camera text-2xl mb-2"></i>
                    <span class="text-xs">上傳圖片</span>
                    <input type="file" @change="handleImageUpload" class="hidden" accept="image/*">
                </label>
                <div v-if="newShoppingItem.image" class="mt-2 text-xs text-green-500 text-center">圖片已選擇</div>
                <button @click="saveShoppingItem" class="w-full bg-sakura-red text-white py-3 rounded-xl font-bold mt-4">加入清單</button>
            </div>
        </div>

        <div v-if="showExpenseModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50" @click.self="showExpenseModal = false">
             <div class="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl p-6">
                <h3 class="font-bold text-lg mb-4">記帳</h3>
                <div class="space-y-3">
                    <select v-model="newExpense.category" class="input-field">
                        <option value="飲食">飲食</option>
                        <option value="交通">交通</option>
                        <option value="購物">購物</option>
                        <option value="門票">門票</option>
                        <option value="住宿">住宿</option>
                        <option value="其他">其他</option>
                    </select>
                    <input type="text" v-model="newExpense.name" class="input-field" placeholder="項目名稱">
                    <input type="number" v-model="newExpense.amount" class="input-field" placeholder="金額 (JPY)">
                    <div class="flex space-x-2">
                        <button @click="newExpense.method='現金'" :class="['flex-1 py-2 rounded-lg border', newExpense.method==='現金' ? 'bg-sakura-red text-white border-transparent' : 'border-gray-200']">現金</button>
                        <button @click="newExpense.method='信用卡'" :class="['flex-1 py-2 rounded-lg border', newExpense.method==='信用卡' ? 'bg-sakura-red text-white border-transparent' : 'border-gray-200']">信用卡</button>
                    </div>
                    <input type="date" v-model="newExpense.date" class="input-field">
                </div>
                <button @click="saveExpense" class="w-full bg-sakura-red text-white py-3 rounded-xl font-bold mt-4 shadow-lg shadow-red-100">儲存</button>
             </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, reactive } = Vue;

        createApp({
            setup() {
                const currentTab = ref('itinerary');
                const currentDayIndex = ref(0);
                const showEditModal = ref(false);
                const showShoppingModal = ref(false);
                const showExpenseModal = ref(false);
                const isEditing = ref(false);
                const editingIndex = ref(-1);

                // 資料結構
                const days = [
                    { date: '11', week: 'Fri', fullDate: '2026-04-11', location: '大阪' },
                    { date: '12', week: 'Sat', fullDate: '2026-04-12', location: '大阪' },
                    { date: '13', week: 'Sun', fullDate: '2026-04-13', location: '環球影城' },
                    { date: '14', week: 'Mon', fullDate: '2026-04-14', location: '大阪/京都' },
                    { date: '15', week: 'Tue', fullDate: '2026-04-15', location: '京都' },
                    { date: '16', week: 'Wed', fullDate: '2026-04-16', location: '京都' },
                    { date: '17', week: 'Thu', fullDate: '2026-04-17', location: '京都/大阪' },
                    { date: '18', week: 'Fri', fullDate: '2026-04-18', location: '大阪/堺' },
                    { date: '19', week: 'Sat', fullDate: '2026-04-19', location: '關西機場' },
                ];

                const hotels = [
                    { dates: '4/11 - 4/14', name: 'BRACKETS HOTEL Osaka Hommachi' },
                    { dates: '4/14 - 4/17', name: 'M\'s Hotel Gojo Odawara' },
                    { dates: '4/17 - 4/18', name: 'Hotel Meldia Osaka Higobashi' },
                    { dates: '4/18 - 4/19', name: '臨空城附近/機場接送' },
                ];

                // 預設行程資料 (從 PDF 提取)
                const defaultItinerary = {
                    0: [ // 4/11
                        { id: 1, category: 'flight', name: 'TPE -> KIX', time: '18:00', note: '抵達關西 22:00，有機場接送', transportTime: 0, transportType: 'car', isFlight: true },
                        { id: 2, category: 'hotel', name: 'Check-in: BRACKETS HOTEL', time: '23:30', note: '本町站附近', transportTime: 45, transportType: 'car' }
                    ],
                    1: [ // 4/12
                        { id: 3, category: 'spot', name: '大阪城', time: '09:00', ticket: '600円', note: '帶學生證，停留1-2小時', transportTime: 14, transportType: 'train' },
                        { id: 4, category: 'food', name: '午餐 (大阪城周邊)', time: '12:00', note: '', transportTime: 10, transportType: 'walk' },
                        { id: 5, category: 'spot', name: '海遊館', time: '14:00', ticket: '2700円', note: '停留3-4小時', transportTime: 32, transportType: 'train' }
                    ],
                    2: [ // 4/13
                        { id: 6, category: 'spot', name: '環球影城 (USJ)', time: '08:00', ticket: '5203円(含快通)', note: '門票+快通4。瑪利歐、哈利波特、小小兵。不能帶外食。', transportTime: 35, transportType: 'train' }
                    ],
                    3: [ // 4/14
                        { id: 7, category: 'spot', name: '難波八阪神社', time: '10:00', note: '', transportTime: 19, transportType: 'train' },
                        { id: 8, category: 'shopping', name: '道頓堀 & 心齋橋', time: '11:00', note: '瘋狂逛街', transportTime: 10, transportType: 'walk' },
                        { id: 9, category: 'shopping', name: '梅田逛街', time: '15:00', note: '友都八喜、Parco、LUCUA。取行李前往京都', transportTime: 12, transportType: 'train' },
                        { id: 10, category: 'hotel', name: 'Check-in: M\'s Hotel 京都', time: '19:00', note: '車程約1小時', transportTime: 60, transportType: 'train' }
                    ],
                    4: [ // 4/15
                        { id: 11, category: 'other', name: '京都國際會館 (研討會)', time: '09:00', note: '參加半天', transportTime: 30, transportType: 'train' },
                        { id: 12, category: 'food', name: '慶祝午餐 (壽喜燒/燒肉)', time: '13:00', note: '吃飽回飯店休息', transportTime: 20, transportType: 'train' },
                        { id: 13, category: 'shopping', name: '四條河原町逛街', time: '16:00', note: '高島屋、新京極。逛街一級戰區', transportTime: 10, transportType: 'walk' }
                    ],
                    5: [ // 4/16
                        { id: 14, category: 'spot', name: '清水寺', time: '09:00', note: '租和服。二三年坂 -> 高台寺 -> 八坂神社 -> 祇園', transportTime: 23, transportType: 'train' },
                        { id: 15, category: 'spot', name: '伏見稻荷 或 嵐山', time: '14:00', note: '方案二選一', transportTime: 30, transportType: 'train' }
                    ],
                    6: [ // 4/17
                        { id: 16, category: 'food', name: 'Smart Coffee', time: '09:00', note: '日式復古早餐', transportTime: 15, transportType: 'walk' },
                        { id: 17, category: 'hotel', name: '移動回大阪 (肥後橋)', time: '11:00', note: 'Hotel Meldia Osaka Higobashi', transportTime: 60, transportType: 'train' },
                        { id: 18, category: 'shopping', name: '補逛街行程', time: '14:00', note: '逛前幾天沒逛完的', transportTime: 20, transportType: 'train' }
                    ],
                    7: [ // 4/18
                        { id: 19, category: 'shopping', name: '天王寺 MIO/Q\'s Mall', time: '10:00', note: '百貨公司10點開', transportTime: 23, transportType: 'train' },
                        { id: 20, category: 'spot', name: '大鳥神社 (堺市)', time: '14:00', note: '在地人推薦，很靈驗', transportTime: 23, transportType: 'train' },
                        { id: 21, category: 'shopping', name: '臨空城 Outlet', time: '16:00', note: '可寄放行李', transportTime: 31, transportType: 'train' }
                    ],
                    8: [ // 4/19
                        { id: 22, category: 'other', name: '前往機場', time: '08:00', note: '飯店接駁車 (5分鐘)', transportTime: 5, transportType: 'car' },
                        { id: 23, category: 'shopping', name: '機場免稅店', time: '08:30', note: '最後採買', transportTime: 0, transportType: 'walk' },
                        { id: 24, category: 'flight', name: 'KIX -> KHH', time: '10:45', note: '回家', transportTime: 0, transportType: 'walk', isFlight: true }
                    ]
                };

                const itineraryData = reactive(JSON.parse(localStorage.getItem('itineraryData')) || defaultItinerary);
                const shoppingList = ref(JSON.parse(localStorage.getItem('shoppingList')) || []);
                const expenses = ref(JSON.parse(localStorage.getItem('expenses')) || []);
                
                // Form Data
                const editForm = reactive({
                    id: null, category: 'spot', name: '', time: '', note: '', ticket: '', transportTime: 30, transportType: 'train'
                });
                const newShoppingItem = reactive({ name: '', image: null, checked: false });
                const newExpense = reactive({ category: '飲食', name: '', amount: '', method: '現金', date: new Date().toISOString().split('T')[0] });

                const calcJpy = ref(null);
                const calcTwd = computed(() => calcJpy.value ? (calcJpy.value * 0.22).toFixed(0) : 0);

                const currentDayItinerary = computed(() => {
                    return itineraryData[currentDayIndex.value] || [];
                });

                const totalExpenses = computed(() => expenses.value.reduce((sum, item) => sum + Number(item.amount), 0));
                const cashExpenses = computed(() => expenses.value.filter(i => i.method === '現金').reduce((sum, item) => sum + Number(item.amount), 0));
                const cardExpenses = computed(() => expenses.value.filter(i => i.method === '信用卡').reduce((sum, item) => sum + Number(item.amount), 0));

                // Helper Functions
                const getCategoryColor = (cat) => {
                    const map = { spot: 'border-pink-400', food: 'border-orange-400', shopping: 'border-purple-400', flight: 'border-blue-400', hotel: 'border-indigo-400', other: 'border-gray-400' };
                    return map[cat] || map.other;
                };
                const getCategoryBg = (cat) => {
                    const map = { spot: 'bg-pink-400', food: 'bg-orange-400', shopping: 'bg-purple-400', flight: 'bg-blue-400', hotel: 'bg-indigo-400', other: 'bg-gray-400' };
                    return map[cat] || map.other;
                };
                const getCategoryIcon = (cat) => {
                    const map = { spot: 'fa-camera', food: 'fa-utensils', shopping: 'fa-bag-shopping', flight: 'fa-plane', hotel: 'fa-bed', other: 'fa-star' };
                    return map[cat] || map.other;
                };
                const getTransportIcon = (type) => {
                    return type === 'walk' ? 'fa-person-walking' : type === 'car' ? 'fa-car' : 'fa-train-subway';
                }
                const getExpenseIcon = (cat) => {
                    const map = { '飲食': 'fa-utensils', '交通': 'fa-train', '購物': 'fa-bag-shopping', '門票': 'fa-ticket', '住宿': 'fa-bed', '其他': 'fa-receipt' };
                    return map[cat] || 'fa-circle';
                }

                // Actions
                const openMap = (location) => {
                    window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(location)}`, '_blank');
                };

                const openAddModal = () => {
                    isEditing.value = false;
                    Object.assign(editForm, { id: Date.now(), category: 'spot', name: '', time: '10:00', note: '', ticket: '', transportTime: 30, transportType: 'train' });
                    showEditModal.value = true;
                };

                const editItem = (item, index) => {
                    isEditing.value = true;
                    editingIndex.value = index;
                    Object.assign(editForm, { ...item });
                    showEditModal.value = true;
                };

                const saveItinerary = () => {
                    editForm.icon = getCategoryIcon(editForm.category);
                    const list = itineraryData[currentDayIndex.value] || [];
                    
                    if (isEditing.value) {
                        list[editingIndex.value] = { ...editForm };
                    } else {
                        if (!itineraryData[currentDayIndex.value]) itineraryData[currentDayIndex.value] = [];
                        itineraryData[currentDayIndex.value].push({ ...editForm });
                    }
                    saveToLocal();
                    closeModal();
                };

                const confirmDelete = () => {
                    if(confirm('確定要刪除此行程嗎？')) {
                        itineraryData[currentDayIndex.value].splice(editingIndex.value, 1);
                        saveToLocal();
                        closeModal();
                    }
                };

                const closeModal = () => showEditModal.value = false;

                const openShoppingModal = () => {
                    newShoppingItem.name = '';
                    newShoppingItem.image = null;
                    showShoppingModal.value = true;
                };

                const handleImageUpload = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => newShoppingItem.image = e.target.result;
                        reader.readAsDataURL(file);
                    }
                };

                const saveShoppingItem = () => {
                    if(newShoppingItem.name) {
                        shoppingList.value.push({ ...newShoppingItem });
                        localStorage.setItem('shoppingList', JSON.stringify(shoppingList.value));
                        showShoppingModal.value = false;
                    }
                };
                
                const deleteShoppingItem = (index) => {
                    shoppingList.value.splice(index, 1);
                    localStorage.setItem('shoppingList', JSON.stringify(shoppingList.value));
                };

                const openExpenseModal = () => {
                    showExpenseModal.value = true;
                }
                const saveExpense = () => {
                    if(newExpense.amount) {
                        expenses.value.unshift({ ...newExpense });
                        localStorage.setItem('expenses', JSON.stringify(expenses.value));
                        showExpenseModal.value = false;
                        newExpense.name = ''; newExpense.amount = '';
                    }
                }
                const deleteExpense = (index) => {
                    if(confirm('刪除此筆記帳？')) {
                        expenses.value.splice(index, 1);
                        localStorage.setItem('expenses', JSON.stringify(expenses.value));
                    }
                }

                const saveToLocal = () => {
                    localStorage.setItem('itineraryData', JSON.stringify(itineraryData));
                };

                // 初始化 SortableJS
                const initSortable = () => {
                    const el = document.getElementById('itinerary-list');
                    if (el) {
                        Sortable.create(el, {
                            handle: '.handle',
                            animation: 150,
                            onEnd: (evt) => {
                                const list = itineraryData[currentDayIndex.value];
                                const item = list.splice(evt.oldIndex, 1)[0];
                                list.splice(evt.newIndex, 0, item);
                                saveToLocal();
                            }
                        });
                    }
                };

                onMounted(() => {
                    nextTick(() => {
                        initSortable();
                    });
                });

                // 當天數切換時重新綁定 Sortable
                Vue.watch(currentDayIndex, () => {
                    nextTick(() => initSortable());
                });

                return {
                    currentTab, currentDayIndex, days, hotels,
                    currentDayItinerary, openMap,
                    showEditModal, editForm, openAddModal, editItem, saveItinerary, closeModal, isEditing, confirmDelete,
                    shoppingList, showShoppingModal, openShoppingModal, newShoppingItem, handleImageUpload, saveShoppingItem, deleteShoppingItem,
                    expenses, showExpenseModal, openExpenseModal, newExpense, saveExpense, deleteExpense, totalExpenses, cashExpenses, cardExpenses,
                    getCategoryColor, getCategoryBg, getCategoryIcon, getTransportIcon, getExpenseIcon,
                    calcJpy, calcTwd
                };
            }
        }).mount('#app');
    </script>
    <style>
        .label-text { @apply block text-xs font-bold text-gray-400 mb-1 ml-1; }
        .input-field { @apply w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-sakura-red focus:bg-white transition-colors; }
        .slide-up-animation { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</body>
</html>