<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>關西之旅 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sakura: {
                            light: '#fff0f5',
                            main: '#ffb7b2',
                            dark: '#ff9e99',
                            red: '#e94e59',
                            text: '#4a4a4a'
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f0f2f5;
            color: #4a4a4a;
            -webkit-tap-highlight-color: transparent;
            display: block; 
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .card-shadow {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        .text-shadow {
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .btn-active:active {
            transform: scale(0.95);
        }
        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #e94e59;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="h-screen overflow-hidden font-sans w-full bg-gray-100">

    <div id="app" class="h-full w-full bg-white shadow-2xl flex flex-col relative">
        
        <header class="relative h-[250px] md:h-[300px] bg-gray-200 overflow-hidden shrink-0 group">
            <img src="./banner.png" 
                 alt="Trip Banner" 
                 class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
            
            <div class="hidden absolute inset-0 bg-sakura-light items-center justify-center text-sakura-main">
                <i class="fa-solid fa-image text-4xl"></i>
            </div>
            
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>

            <div class="absolute bottom-6 left-6 md:left-10 z-10 text-white">
                <h1 class="text-4xl md:text-5xl font-bold tracking-widest text-shadow">關西之旅</h1>
                <p class="text-sm md:text-base font-medium opacity-90 mt-2 text-shadow"><i class="fa-regular fa-calendar mr-2"></i>2026.04.11 - 04.19</p>
            </div>

            <div class="absolute bottom-6 right-6 md:right-10 flex space-x-4 z-20">
                <button @click="currentTab = 'itinerary'" :class="['w-12 h-12 rounded-full flex items-center justify-center transition-all shadow-lg backdrop-blur-sm', currentTab === 'itinerary' ? 'bg-sakura-red text-white scale-110' : 'bg-white/90 text-gray-500 hover:bg-white']">
                    <i class="fa-solid fa-map-location-dot text-lg"></i>
                </button>
                <button @click="currentTab = 'info'" :class="['w-12 h-12 rounded-full flex items-center justify-center transition-all shadow-lg backdrop-blur-sm', currentTab === 'info' ? 'bg-sakura-red text-white scale-110' : 'bg-white/90 text-gray-500 hover:bg-white']">
                    <i class="fa-solid fa-circle-info text-lg"></i>
                </button>
                <button @click="currentTab = 'shopping'" :class="['w-12 h-12 rounded-full flex items-center justify-center transition-all shadow-lg backdrop-blur-sm', currentTab === 'shopping' ? 'bg-sakura-red text-white scale-110' : 'bg-white/90 text-gray-500 hover:bg-white']">
                    <i class="fa-solid fa-basket-shopping text-lg"></i>
                </button>
                <button @click="currentTab = 'expenses'" :class="['w-12 h-12 rounded-full flex items-center justify-center transition-all shadow-lg backdrop-blur-sm', currentTab === 'expenses' ? 'bg-sakura-red text-white scale-110' : 'bg-white/90 text-gray-500 hover:bg-white']">
                    <i class="fa-solid fa-coins text-lg"></i>
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar relative bg-gray-50 pb-20">
            
            <div class="w-full h-full max-w-7xl mx-auto"> 
                
                <div v-if="currentTab === 'itinerary'" class="h-full flex flex-col">
                    <div class="bg-white sticky top-0 z-30 shadow-sm border-b border-gray-100 py-4">
                        <div class="flex overflow-x-auto no-scrollbar px-4 md:px-10 space-x-4 md:justify-center">
                            <div v-for="(day, index) in days" :key="index" 
                                 @click="currentDayIndex = index"
                                 :class="['flex-shrink-0 flex flex-col items-center justify-center w-16 h-18 md:w-20 md:h-20 rounded-2xl transition-all cursor-pointer', currentDayIndex === index ? 'bg-sakura-red text-white shadow-lg transform -translate-y-1' : 'bg-white text-gray-400 border border-gray-100 hover:bg-gray-50']">
                                <span class="text-xs md:text-sm font-medium">{{ day.week }}</span>
                                <span class="text-xl md:text-2xl font-bold">{{ day.date }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 md:p-8 grid md:grid-cols-12 gap-6">
                        <div class="md:col-span-3 lg:col-span-3">
                            <div class="p-6 bg-gradient-to-r from-blue-50 to-white rounded-2xl flex md:flex-col items-center justify-between md:justify-center card-shadow border border-blue-50 sticky top-32">
                                <div class="md:text-center md:mb-4">
                                    <div class="text-sm text-gray-400 mb-1">
                                        <i class="fa-solid fa-location-dot mr-1"></i>
                                        {{ days[currentDayIndex].location }}
                                    </div>
                                    <div class="flex items-baseline md:justify-center">
                                        <span class="text-4xl font-light text-gray-700">18°</span>
                                        <span class="text-sm text-gray-400 ml-2">體感 16°</span>
                                    </div>
                                </div>
                                <div class="text-center text-blue-300">
                                    <i class="fa-solid fa-cloud-sun text-5xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="md:col-span-9 lg:col-span-9 space-y-0" id="itinerary-list">
                            <div v-for="(item, index) in currentDayItinerary" :key="item.id" class="relative group itinerary-item">
                                
                                <div v-if="index > 0" class="flex items-center justify-center py-2 relative">
                                    <div class="h-8 w-0.5 bg-gray-200 absolute top-0 bottom-0 z-0"></div>
                                    <div class="bg-white border border-gray-200 text-gray-400 text-xs px-3 py-1 rounded-full z-10 flex items-center space-x-1 cursor-pointer hover:bg-gray-50 shadow-sm">
                                        <i :class="getTransportIcon(item.transportType)"></i>
                                        <span>{{ item.transportTime }} min</span>
                                    </div>
                                </div>
                                <div v-else-if="index === 0 && !item.isFlight" class="flex items-center justify-center py-2 pb-4">
                                    <div class="text-xs text-gray-400 bg-gray-200 px-3 py-1 rounded-full">
                                        <i class="fa-solid fa-hotel mr-1"></i> 從飯店出發約 {{ item.transportTime }} min
                                    </div>
                                </div>

                                <div @click="openMap(item.name)" 
                                     :class="['relative bg-white rounded-2xl p-6 card-shadow border-l-4 cursor-pointer active:scale-[0.99] transition-transform hover:shadow-lg', getCategoryColor(item.category)]">
                                    
                                    <div class="absolute top-4 right-4 text-gray-200 handle cursor-move hover:text-gray-400 p-2">
                                        <i class="fa-solid fa-grip-lines text-lg"></i>
                                    </div>

                                    <div class="flex items-start">
                                        <div :class="['w-12 h-12 rounded-full flex items-center justify-center text-white shrink-0 shadow-md text-lg', getCategoryBg(item.category)]">
                                            <i :class="item.icon"></i>
                                        </div>
                                        
                                        <div class="ml-6 flex-1 overflow-hidden">
                                            <div class="flex justify-between items-baseline pr-8">
                                                <h3 class="font-bold text-gray-700 text-xl">{{ item.name }}</h3>
                                            </div>
                                            <div class="text-sakura-red font-medium text-base mt-1">
                                                {{ item.time }}
                                            </div>

                                            <div class="flex flex-wrap gap-2 mt-3">
                                                <span v-if="item.ticket" class="text-sm bg-yellow-50 text-yellow-600 px-2 py-1 rounded border border-yellow-100">
                                                    <i class="fa-solid fa-ticket mr-1"></i>{{ item.ticket }}
                                                </span>
                                                <span v-if="item.openTime" class="text-sm bg-gray-50 text-gray-500 px-2 py-1 rounded border border-gray-100">
                                                    <i class="fa-regular fa-clock mr-1"></i>{{ item.openTime }}
                                                </span>
                                            </div>

                                            <p v-if="item.note" class="text-sm text-gray-500 mt-3 leading-relaxed bg-gray-50 p-3 rounded-lg">
                                                {{ item.note }}
                                            </p>

                                            <div v-if="item.images && item.images.length > 0" class="mt-4">
                                                <div class="flex space-x-3 overflow-x-auto no-scrollbar pb-2">
                                                    <img v-for="(img, imgIdx) in item.images" 
                                                         :key="imgIdx" 
                                                         :src="img" 
                                                         class="h-40 w-auto rounded-xl border border-gray-100 shadow-sm cursor-pointer hover:opacity-90 transition-opacity"
                                                         @click.stop="openImage(img)">
                                                </div>
                                            </div>
                                            <div v-else-if="item.image" class="mt-4">
                                                <img :src="item.image" class="w-full md:w-2/3 h-48 object-cover rounded-xl border border-gray-100 shadow-sm">
                                            </div>

                                        </div>
                                    </div>
                                    
                                    <div class="absolute bottom-3 right-3 flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button @click.stop="editItem(item, index)" class="text-gray-400 hover:text-blue-500 p-2 bg-gray-50 rounded-full">
                                            <i class="fa-solid fa-pen"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="currentTab === 'info'" class="space-y-8 pb-10 p-4 md:p-8">
                     <div>
                        <h3 class="text-xl font-bold text-gray-700 mb-6 flex items-center">
                            <i class="fa-solid fa-camera-retro mr-3 text-sakura-red"></i>
                            景點導覽
                        </h3>
                        <div class="flex overflow-x-auto no-scrollbar space-x-6 pb-4">
                            <div v-for="spot in attractions" :key="spot.name" 
                                 class="flex-shrink-0 w-72 md:w-80 bg-white rounded-2xl overflow-hidden card-shadow group cursor-pointer hover:shadow-xl transition-all"
                                 @click="openMap(spot.name)">
                                <div class="h-48 overflow-hidden relative">
                                    <img :src="spot.image" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
                                    <div class="absolute bottom-0 inset-x-0 bg-gradient-to-t from-black/70 to-transparent p-4 pt-10">
                                        <div class="text-white font-bold text-xl text-shadow">{{ spot.name }}</div>
                                    </div>
                                </div>
                                <div class="p-5">
                                    <div class="text-xs text-sakura-red font-bold mb-2 uppercase tracking-wide border border-sakura-red/30 inline-block px-2 py-0.5 rounded">{{ spot.tag }}</div>
                                    <p class="text-sm text-gray-500 leading-relaxed">{{ spot.desc }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>

                <div v-if="currentTab === 'shopping'" class="p-4 md:p-8">
                     <div v-if="shoppingList.length === 0" class="flex flex-col items-center justify-center py-20 text-gray-400 h-[60vh]">
                        <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center mb-6 shadow-sm">
                            <i class="fa-solid fa-basket-shopping text-4xl text-gray-300"></i>
                        </div>
                        <p class="text-lg">目前沒有購物清單</p>
                    </div>
                    <div v-else class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6">
                        <div v-for="(item, index) in shoppingList" :key="index" class="bg-white rounded-xl card-shadow overflow-hidden relative group hover:-translate-y-1 transition-transform duration-300">
                            <div class="h-40 md:h-48 bg-gray-100 flex items-center justify-center overflow-hidden">
                                <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                                <i v-else class="fa-solid fa-camera text-gray-300 text-3xl"></i>
                            </div>
                            <div class="p-4">
                                <h4 class="font-bold text-gray-700 truncate text-lg">{{ item.name }}</h4>
                                <div class="flex items-center justify-between mt-3">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" v-model="item.checked" class="w-5 h-5 accent-sakura-red">
                                        <span class="text-xs ml-2 text-gray-400" v-if="item.checked">已購買</span>
                                    </label>
                                    <button @click="deleteShoppingItem(index)" class="text-gray-300 hover:text-red-400 p-1"><i class="fa-solid fa-trash-can"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="currentTab === 'expenses'" class="flex flex-col h-full p-4 md:p-8">
                     <div class="bg-white p-6 md:p-10 rounded-2xl card-shadow text-center mb-6 max-w-2xl mx-auto w-full">
                        <p class="text-sm text-gray-400">總支出 (JPY)</p>
                        <div class="text-5xl font-bold text-sakura-red mt-3">¥ {{ totalExpenses.toLocaleString() }}</div>
                    </div>
                </div>
            
            </div> </main>

        <button v-if="currentTab === 'itinerary'" @click="openAddModal" class="fixed bottom-24 right-6 w-16 h-16 bg-sakura-red text-white rounded-full shadow-xl shadow-red-200 flex items-center justify-center text-3xl btn-active z-40 hover:scale-110 transition-transform">
            <i class="fa-solid fa-plus"></i>
        </button>
        <button v-if="currentTab === 'shopping'" @click="openShoppingModal" class="fixed bottom-24 right-6 w-16 h-16 bg-sakura-red text-white rounded-full shadow-xl shadow-red-200 flex items-center justify-center text-3xl btn-active z-40 hover:scale-110 transition-transform">
            <i class="fa-solid fa-plus"></i>
        </button>
        <button v-if="currentTab === 'expenses'" @click="openExpenseModal" class="fixed bottom-24 right-6 w-16 h-16 bg-sakura-red text-white rounded-full shadow-xl shadow-red-200 flex items-center justify-center text-3xl btn-active z-40 hover:scale-110 transition-transform">
            <i class="fa-solid fa-plus"></i>
        </button>

        <div v-if="showEditModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="closeModal">
            <div class="bg-white w-full max-w-lg rounded-t-2xl sm:rounded-2xl p-6 slide-up-animation h-[90vh] sm:h-auto flex flex-col shadow-2xl">
                <h3 class="text-xl font-bold mb-6 text-center shrink-0">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
                
                <div class="space-y-5 flex-1 overflow-y-auto pr-2">
                    <div>
                        <label class="label-text">分類</label>
                        <select v-model="editForm.category" class="input-field">
                            <option value="spot">景點</option>
                            <option value="food">美食</option>
                            <option value="shopping">購物</option>
                            <option value="hotel">住宿</option>
                            <option value="flight">航班</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    <div>
                        <label class="label-text">名稱</label>
                        <input type="text" v-model="editForm.name" class="input-field" placeholder="行程名稱">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="label-text">時間</label>
                            <input type="time" v-model="editForm.time" class="input-field">
                        </div>
                         <div>
                            <label class="label-text">交通時間(分)</label>
                            <input type="number" v-model="editForm.transportTime" class="input-field" placeholder="30">
                        </div>
                    </div>
                     <div>
                        <label class="label-text">交通方式</label>
                        <select v-model="editForm.transportType" class="input-field">
                            <option value="walk">步行</option>
                            <option value="train">大眾運輸</option>
                            <option value="car">開車/接送</option>
                        </select>
                    </div>
                    <div v-if="editForm.category === 'spot'">
                         <label class="label-text">門票</label>
                        <input type="text" v-model="editForm.ticket" class="input-field" placeholder="費用或預約資訊">
                    </div>
                    <div>
                        <label class="label-text">備註/營業時間</label>
                        <textarea v-model="editForm.note" class="input-field h-24"></textarea>
                    </div>

                    <div>
                        <label class="label-text flex items-center justify-between">
                            <span>行程圖片 (可多選)</span>
                            <span v-if="isCompressing" class="text-xs text-sakura-red flex items-center"><div class="loader mr-1"></div>處理中...</span>
                        </label>
                        <div class="grid grid-cols-3 sm:grid-cols-4 gap-3 mb-3">
                            <div v-for="(img, idx) in editForm.images" :key="idx" class="relative aspect-square group">
                                <img :src="img" class="w-full h-full object-cover rounded-xl border border-gray-200">
                                <button @click="removeImage(idx)" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full shadow-md flex items-center justify-center hover:scale-110 transition-transform">
                                    <i class="fa-solid fa-times text-xs"></i>
                                </button>
                            </div>

                            <label class="aspect-square bg-gray-50 rounded-xl flex flex-col items-center justify-center cursor-pointer border-2 border-dashed border-gray-300 hover:border-sakura-red hover:bg-red-50 transition-all">
                                <i class="fa-solid fa-camera text-gray-400 text-xl mb-1"></i>
                                <span class="text-[10px] text-gray-400">新增</span>
                                <input type="file" @change="handleItineraryImageUpload" class="hidden" accept="image/*" multiple>
                            </label>
                        </div>
                        <p class="text-xs text-gray-400">已選擇 {{ editForm.images ? editForm.images.length : 0 }} 張照片</p>
                    </div>

                </div>

                <div class="flex space-x-4 mt-8 shrink-0">
                    <button v-if="isEditing" @click="confirmDelete" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-500 py-3.5 rounded-xl font-bold transition-colors">刪除</button>
                    <button @click="saveItinerary" class="flex-[2] bg-sakura-red hover:bg-sakura-dark text-white py-3.5 rounded-xl font-bold shadow-lg shadow-red-100 transition-colors" :disabled="isCompressing">
                        {{ isCompressing ? '處理圖片中...' : '儲存' }}
                    </button>
                </div>
            </div>
        </div>

        <div v-if="showShoppingModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" @click.self="showShoppingModal = false">
            <div class="bg-white w-full max-w-md rounded-2xl p-8 m-4 shadow-2xl">
                <h3 class="font-bold text-xl mb-6 text-center">新增購物清單</h3>
                <input type="text" v-model="newShoppingItem.name" class="input-field mb-6" placeholder="商品名稱">
                <label class="block w-full h-40 border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center text-gray-400 cursor-pointer hover:border-sakura-red hover:text-sakura-red transition-all bg-gray-50">
                    <i class="fa-solid fa-camera text-3xl mb-3"></i>
                    <span class="text-sm font-medium">上傳參考圖片</span>
                    <input type="file" @change="handleImageUpload" class="hidden" accept="image/*">
                </label>
                <div v-if="newShoppingItem.image" class="mt-3 text-sm text-green-600 text-center font-medium"><i class="fa-solid fa-check mr-1"></i>圖片已選擇</div>
                <button @click="saveShoppingItem" class="w-full bg-sakura-red hover:bg-sakura-dark text-white py-3.5 rounded-xl font-bold mt-6 shadow-lg shadow-red-100 transition-colors">加入清單</button>
            </div>
        </div>

        <div v-if="showExpenseModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50" @click.self="showExpenseModal = false">
             <div class="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl p-8 shadow-2xl">
                <h3 class="font-bold text-xl mb-6 text-center">記帳</h3>
                <div class="space-y-4">
                    <select v-model="newExpense.category" class="input-field">
                        <option value="飲食">飲食</option>
                        <option value="交通">交通</option>
                        <option value="購物">購物</option>
                        <option value="門票">門票</option>
                        <option value="住宿">住宿</option>
                        <option value="其他">其他</option>
                    </select>
                    <input type="text" v-model="newExpense.name" class="input-field" placeholder="項目名稱">
                    <input type="number" v-model="newExpense.amount" class="input-field" placeholder="金額 (JPY)">
                    <div class="flex space-x-3">
                        <button @click="newExpense.method='現金'" :class="['flex-1 py-2.5 rounded-xl border font-medium transition-colors', newExpense.method==='現金' ? 'bg-sakura-red text-white border-transparent shadow-md' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50']">現金</button>
                        <button @click="newExpense.method='信用卡'" :class="['flex-1 py-2.5 rounded-xl border font-medium transition-colors', newExpense.method==='信用卡' ? 'bg-sakura-red text-white border-transparent shadow-md' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50']">信用卡</button>
                    </div>
                    <input type="date" v-model="newExpense.date" class="input-field">
                </div>
                <button @click="saveExpense" class="w-full bg-sakura-red hover:bg-sakura-dark text-white py-3.5 rounded-xl font-bold mt-6 shadow-lg shadow-red-100 transition-colors">儲存</button>
             </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, reactive } = Vue;

        createApp({
            setup() {
                const currentTab = ref('itinerary');
                const currentDayIndex = ref(0);
                const showEditModal = ref(false);
                const showShoppingModal = ref(false);
                const showExpenseModal = ref(false);
                const isEditing = ref(false);
                const editingIndex = ref(-1);
                const isCompressing = ref(false); // Loading state for images

                const days = [
                    { date: '11', week: 'Fri', fullDate: '2026-04-11', location: '大阪' },
                    { date: '12', week: 'Sat', fullDate: '2026-04-12', location: '大阪' },
                    { date: '13', week: 'Sun', fullDate: '2026-04-13', location: '環球影城' },
                    { date: '14', week: 'Mon', fullDate: '2026-04-14', location: '大阪/京都' },
                    { date: '15', week: 'Tue', fullDate: '2026-04-15', location: '京都' },
                    { date: '16', week: 'Wed', fullDate: '2026-04-16', location: '京都' },
                    { date: '17', week: 'Thu', fullDate: '2026-04-17', location: '京都/大阪' },
                    { date: '18', week: 'Fri', fullDate: '2026-04-18', location: '大阪/堺' },
                    { date: '19', week: 'Sat', fullDate: '2026-04-19', location: '關西機場' },
                ];

                // Static Data for attractions/hotels (same as before)
                const hotels = [
                    { dates: '4/11 - 4/14', name: 'BRACKETS HOTEL Osaka Hommachi' },
                    { dates: '4/14 - 4/17', name: 'M\'s Hotel Gojo Odawara' },
                    { dates: '4/17 - 4/18', name: 'Hotel Meldia Osaka Higobashi' },
                    { dates: '4/18 - 4/19', name: 'EZ HOTEL 關西空港 Seaside' },
                ];
                const attractions = [
                    { name: '大阪城', tag: '歷史地標', image: 'https://images.unsplash.com/photo-1590253232502-122fdf9382e7', desc: '大阪代表性人氣旅遊點。' },
                    { name: '環球影城', tag: '主題樂園', image: 'https://images.unsplash.com/photo-1624601476296-3ac93782eb83', desc: '超級任天堂世界、哈利波特魔法世界。' },
                    { name: '道頓堀', tag: '逛街美食', image: 'https://images.unsplash.com/photo-1595500609384-56c6628c6143', desc: '大阪代表性的繁華街。' },
                    { name: '清水寺', tag: '京都古蹟', image: 'https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e', desc: '京都最著名的古老寺院。' },
                    { name: '海遊館', tag: '水族館', image: 'https://images.unsplash.com/photo-1571216584227-2b740523098f', desc: '港灣區域受全球矚目的水族館。' }
                ];

                const defaultItinerary = {
                    0: [
                        { id: 1, category: 'flight', name: 'TPE -> KIX', time: '18:00', note: '抵達關西 22:00', transportTime: 0, transportType: 'car', isFlight: true, images: [] },
                        { id: 2, category: 'hotel', name: 'Check-in', time: '23:30', note: '本町站附近', transportTime: 45, transportType: 'car', images: [] }
                    ]
                };

                const itineraryData = reactive(JSON.parse(localStorage.getItem('itineraryData')) || defaultItinerary);
                const shoppingList = ref(JSON.parse(localStorage.getItem('shoppingList')) || []);
                const expenses = ref(JSON.parse(localStorage.getItem('expenses')) || []);
                
                const editForm = reactive({
                    id: null, category: 'spot', name: '', time: '', note: '', ticket: '', 
                    transportTime: 30, transportType: 'train', image: null, images: []
                });
                
                const newShoppingItem = reactive({ name: '', image: null, checked: false });
                const newExpense = reactive({ category: '飲食', name: '', amount: '', method: '現金', date: new Date().toISOString().split('T')[0] });

                const calcJpy = ref(null);
                const calcTwd = computed(() => calcJpy.value ? (calcJpy.value * 0.22).toFixed(0) : 0);
                const currentDayItinerary = computed(() => itineraryData[currentDayIndex.value] || []);
                const totalExpenses = computed(() => expenses.value.reduce((sum, item) => sum + Number(item.amount), 0));

                // Helper Functions (Same as before)
                const getCategoryColor = (cat) => ({ spot: 'border-pink-400', food: 'border-orange-400', shopping: 'border-purple-400', flight: 'border-blue-400', hotel: 'border-indigo-400', other: 'border-gray-400' }[cat] || 'border-gray-400');
                const getCategoryBg = (cat) => ({ spot: 'bg-pink-400', food: 'bg-orange-400', shopping: 'bg-purple-400', flight: 'bg-blue-400', hotel: 'bg-indigo-400', other: 'bg-gray-400' }[cat] || 'bg-gray-400');
                const getCategoryIcon = (cat) => ({ spot: 'fa-camera', food: 'fa-utensils', shopping: 'fa-bag-shopping', flight: 'fa-plane', hotel: 'fa-bed', other: 'fa-star' }[cat] || 'fa-star');
                const getTransportIcon = (type) => type === 'walk' ? 'fa-person-walking' : type === 'car' ? 'fa-car' : 'fa-train-subway';
                
                // --- CORE IMAGE COMPRESSION LOGIC ---
                const compressImage = (file) => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = (event) => {
                            const img = new Image();
                            img.src = event.target.result;
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                
                                // Resize Logic: Max width 800px
                                const MAX_WIDTH = 800;
                                let width = img.width;
                                let height = img.height;
                                if (width > MAX_WIDTH) {
                                    height *= MAX_WIDTH / width;
                                    width = MAX_WIDTH;
                                }
                                
                                canvas.width = width;
                                canvas.height = height;
                                ctx.drawImage(img, 0, 0, width, height);
                                
                                // Compress: JPEG with 0.7 quality
                                resolve(canvas.toDataURL('image/jpeg', 0.7));
                            }
                        }
                    });
                };

                const handleItineraryImageUpload = async (event) => {
                    const files = event.target.files;
                    if (files && files.length > 0) {
                        isCompressing.value = true; // Show loading
                        if (!editForm.images) editForm.images = [];
                        
                        try {
                            for (let i = 0; i < files.length; i++) {
                                // Await the compression result
                                const compressedBase64 = await compressImage(files[i]);
                                editForm.images.push(compressedBase64);
                            }
                        } catch (error) {
                            console.error("Image processing error", error);
                            alert("圖片處理失敗，請重試");
                        } finally {
                            isCompressing.value = false; // Hide loading
                        }
                    }
                };
                // -------------------------------------

                const openAddModal = () => {
                    isEditing.value = false;
                    Object.assign(editForm, { 
                        id: Date.now(), category: 'spot', name: '', time: '10:00', note: '', 
                        ticket: '', transportTime: 30, transportType: 'train', 
                        image: null, images: [] 
                    });
                    showEditModal.value = true;
                };

                const editItem = (item, index) => {
                    isEditing.value = true;
                    editingIndex.value = index;
                    const itemCopy = JSON.parse(JSON.stringify(item));
                    if (itemCopy.image && (!itemCopy.images || itemCopy.images.length === 0)) itemCopy.images = [itemCopy.image];
                    if (!itemCopy.images) itemCopy.images = [];
                    Object.assign(editForm, itemCopy);
                    showEditModal.value = true;
                };

                const saveItinerary = () => {
                    editForm.icon = getCategoryIcon(editForm.category);
                    if(editForm.images.length > 0) editForm.image = editForm.images[0]; // Sync
                    
                    if (!itineraryData[currentDayIndex.value]) itineraryData[currentDayIndex.value] = [];
                    
                    if (isEditing.value) itineraryData[currentDayIndex.value][editingIndex.value] = { ...editForm };
                    else itineraryData[currentDayIndex.value].push({ ...editForm });
                    
                    saveToLocal(); // This now has error handling
                    closeModal();
                };

                const saveToLocal = () => {
                    try {
                        localStorage.setItem('itineraryData', JSON.stringify(itineraryData));
                        localStorage.setItem('shoppingList', JSON.stringify(shoppingList.value));
                        localStorage.setItem('expenses', JSON.stringify(expenses.value));
                    } catch (e) {
                        if (e.name === 'QuotaExceededError') {
                            alert("儲存失敗！\n\n您的瀏覽器儲存空間已滿 (通常是圖片太多)。\n請刪除部分行程或圖片後再試。");
                        } else {
                            alert("儲存發生未知錯誤");
                        }
                    }
                };

                // Simple compression for shopping items too
                const handleImageUpload = async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const compressed = await compressImage(file);
                        newShoppingItem.image = compressed;
                    }
                };

                const openMap = (loc) => window.open(`http://googleusercontent.com/maps.google.com/3{encodeURIComponent(loc)}`, '_blank');
                const openImage = (url) => window.open(url, '_blank');
                const closeModal = () => showEditModal.value = false;
                const confirmDelete = () => { if(confirm('刪除？')) { itineraryData[currentDayIndex.value].splice(editingIndex.value, 1); saveToLocal(); closeModal(); } };
                const removeImage = (idx) => editForm.images.splice(idx, 1);

                // Shopping & Expenses Logic (Unchanged but using safe saveToLocal)
                const saveShoppingItem = () => { if(newShoppingItem.name) { shoppingList.value.push({ ...newShoppingItem }); saveToLocal(); showShoppingModal.value = false; } };
                const deleteShoppingItem = (idx) => { shoppingList.value.splice(idx, 1); saveToLocal(); };
                const openExpenseModal = () => showExpenseModal.value = true;
                const saveExpense = () => { if(newExpense.amount) { expenses.value.unshift({ ...newExpense }); saveToLocal(); showExpenseModal.value = false; newExpense.name = ''; newExpense.amount = ''; } };

                // Sortable Init (Unchanged)
                const initSortable = () => {
                    const el = document.getElementById('itinerary-list');
                    if (el) Sortable.create(el, { handle: '.handle', animation: 150, onEnd: (evt) => {
                        const list = itineraryData[currentDayIndex.value];
                        const item = list.splice(evt.oldIndex, 1)[0];
                        list.splice(evt.newIndex, 0, item);
                        saveToLocal();
                    }});
                };
                onMounted(() => nextTick(() => initSortable()));
                Vue.watch(currentDayIndex, () => nextTick(() => initSortable()));

                return {
                    currentTab, currentDayIndex, days, hotels, attractions,
                    currentDayItinerary, openMap, openImage,
                    showEditModal, editForm, openAddModal, editItem, saveItinerary, closeModal, isEditing, confirmDelete,
                    shoppingList, showShoppingModal, openShoppingModal, newShoppingItem, handleImageUpload, saveShoppingItem, deleteShoppingItem,
                    expenses, showExpenseModal, openExpenseModal, newExpense, saveExpense, totalExpenses,
                    getCategoryColor, getCategoryBg, getCategoryIcon, getTransportIcon,
                    calcJpy, calcTwd, handleItineraryImageUpload, removeImage, isCompressing
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
